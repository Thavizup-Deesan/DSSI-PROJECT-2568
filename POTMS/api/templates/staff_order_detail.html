{% extends 'base.html' %}

{% block content %}
<div class="space-y-6">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs">
        <ul>
            <li><a href="/api/staff/dashboard/">Dashboard</a></li>
            <li>ตรวจสอบใบขอซื้อ {{ order_id }}</li>
        </ul>
    </div>

    <!-- Header & Actions -->
    <div class="flex justify-between items-start">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold text-gray-800" id="orderNo">Loading...</h1>
                <span id="statusBadge" class="badge badge-lg">Loading...</span>
            </div>
            <p class="text-gray-500 mt-1">วันที่ส่ง: <span id="submitDate">-</span></p>
        </div>
        
        <div class="space-x-2" id="actionButtons">
            <!-- Buttons injected based on status -->
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Left Column: Order Details -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Project Info -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2">ข้อมูลโครงการ</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="block text-sm text-gray-500">รหัสโครงการ</span>
                        <span class="font-mono font-medium" id="projectCode">-</span>
                    </div>
                    <div>
                        <span class="block text-sm text-gray-500">ชื่อโครงการ</span>
                        <span class="font-semibold" id="projectName">-</span>
                    </div>
                    <div>
                        <span class="block text-sm text-gray-500">ผู้ขอซื้อ</span>
                        <span id="requesterName">-</span>
                    </div>
                    <div>
                        <span class="block text-sm text-gray-500">วันที่ต้องการใช้</span>
                        <span id="requiredDate">-</span>
                    </div>
                </div>
            </div>

            <!-- Items Information -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2">รายการขอซื้อ</h3>
                <table class="table w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th>#</th>
                            <th>รายการ</th>
                            <th class="text-right">จำนวน</th>
                            <th class="text-center">หน่วย</th>
                            <th class="text-right">ราคา/หน่วย</th>
                            <th class="text-right">รวม</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                    </tbody>
                    <tfoot>
                        <tr class="font-bold bg-gray-50 text-gray-800 text-lg">
                            <td colspan="5" class="text-right">ยอดรวมสุทธิ</td>
                            <td class="text-right" id="grandTotal">0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Right Column: Verification & Logs -->
        <div class="space-y-6">
            <!-- Verification Checklist -->
             <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-gray-800 mb-4">การตรวจสอบ (Staff)</h3>
                
                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-4">
                        <input type="checkbox" class="checkbox checkbox-primary" id="checkBudget" />
                        <span class="label-text">งบประมาณเพียงพอ</span>
                    </label>
                </div>
                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-4">
                        <input type="checkbox" class="checkbox checkbox-primary" id="checkSpecs" />
                        <span class="label-text">สเปคถูกต้อง/สมเหตุสมผล</span>
                    </label>
                </div>
                 <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-4">
                        <input type="checkbox" class="checkbox checkbox-primary" id="checkDocs" />
                        <span class="label-text">เอกสารครบถ้วน</span>
                    </label>
                </div>

                <div class="divider"></div>
                
                <div class="form-control w-full">
                    <label class="label"><span class="label-text font-bold">หมายเหตุ / เหตุผล</span></label>
                    <textarea class="textarea textarea-bordered h-24" id="staffNote" placeholder="ระบุเหตุผลกรณีส่งกลับแก้ไข หรือไม่อนุมัติ"></textarea>
                </div>
             </div>
        </div>

    </div>
</div>

<!-- Modal for Confirm Reject/Return -->
<!-- (Using SweetAlert2 instead of manual modal for simplicity) -->

{% endblock %}

{% block extra_js %}
<script>
    const orderId = "{{ order_id }}";

    document.addEventListener('DOMContentLoaded', async () => {
        await loadOrderDetails();
    });

    async function loadOrderDetails() {
        try {
            const res = await fetchAPI(`/api/orders/${orderId}/`);
            if (!res.ok) throw new Error('Failed to load');
            const data = await res.json();
            renderOrder(data);
        } catch (err) {
            Swal.fire('Error', 'ไม่สามารถฟโหลดข้อมูลได้', 'error');
        }
    }

    function renderOrder(order) {
        document.getElementById('orderNo').textContent = order.order_no || 'Draft';
        document.getElementById('submitDate').textContent = order.submitted_at 
            ? new Date(order.submitted_at).toLocaleDateString('th-TH') 
            : '-';
        
        // Status Badge
        const badge = document.getElementById('statusBadge');
        badge.className = `badge badge-lg ${getStatusClass(order.status)}`;
        badge.textContent = order.status;

        // Info
        document.getElementById('projectCode').textContent = order.project_code || '-';
        document.getElementById('projectName').textContent = order.project_name || '-';
        document.getElementById('requesterName').textContent = order.requester_name || '-';
        document.getElementById('requiredDate').textContent = order.required_date || '-';

        // Items
        const tbody = document.getElementById('itemsTableBody');
        let total = 0;
        tbody.innerHTML = (order.items || []).map((item, index) => {
            const itemTotal = (item.quantity || 0) * (item.estimated_unit_price || 0);
            total += itemTotal;
            return `
                <tr>
                    <th>${index + 1}</th>
                    <td>${item.item_name}</td>
                    <td class="text-right">${item.quantity}</td>
                    <td class="text-center">${item.unit}</td>
                    <td class="text-right">${(item.estimated_unit_price || 0).toLocaleString()}</td>
                    <td class="text-right font-medium">${itemTotal.toLocaleString()}</td>
                </tr>
            `;
        }).join('');
        document.getElementById('grandTotal').textContent = total.toLocaleString(undefined, {minimumFractionDigits: 2});

        // Action Buttons Logic
        const btnContainer = document.getElementById('actionButtons');
        if (order.status === 'Pending') {
            btnContainer.innerHTML = `
                <button onclick="requestCorrection()" class="btn btn-warning btn-sm text-white">
                    <i class="fa-solid fa-rotate-left mr-1"></i> ส่งกลับแก้ไข
                </button>
                <button onclick="rejectOrder()" class="btn btn-error btn-sm text-white">
                    <i class="fa-solid fa-times mr-1"></i> ไม่อนุมัติ
                </button>
                <button onclick="approveOrder()" class="btn btn-success btn-sm text-white">
                    <i class="fa-solid fa-check mr-1"></i> อนุมัติ (ดำเนินการต่อ)
                </button>
            `;
        } else {
            btnContainer.innerHTML = `<span class="text-gray-400 text-sm">ไม่มีการดำเนินการสำหรับสถานะนี้</span>`;
        }
    }

    function getStatusClass(status) {
        switch(status) {
            case 'Pending': return 'badge-warning';
            case 'Approved': return 'badge-success';
            case 'Rejected': return 'badge-error';
            case 'CorrectionNeeded': return 'badge-warning';
            default: return 'badge-ghost';
        }
    }

    // Actions
    async function approveOrder() {
        if (!document.getElementById('checkBudget').checked) {
            Swal.fire('แจ้งเตือน', 'กรุณาตรวจสอบงบประมาณก่อนอนุมัติ', 'warning');
            return;
        }

        const confirm = await Swal.fire({
            title: 'ยืนยันการอนุมัติ?',
            text: 'ใบขอซื้อจะถูกเปลี่ยนสถานะเป็น "Approved" และดำเนินการต่อ',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#4f46e5',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'ยืนยันอนุมัติ',
            cancelButtonText: 'ยกเลิก'
        });

        if (confirm.isConfirmed) {
            postAction('approve');
        }
    }

    async function rejectOrder() {
        const note = document.getElementById('staffNote').value;
        if (!note) {
            Swal.fire('แจ้งเตือน', 'กรุณาระบุเหตุผลในการไม่อนุมัติ', 'warning');
            return;
        }
        
        const confirm = await Swal.fire({
            title: 'ยืนยันไม่อนุมัติ?',
            text: 'กรุณายืนยันการปฏิเสธใบขอซื้อนี้',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'ไม่อนุมัติ',
            cancelButtonText: 'ยกเลิก'
        });

        if (confirm.isConfirmed) {
            postAction('reject', note);
        }
    }

    async function requestCorrection() {
        const note = document.getElementById('staffNote').value;
        if (!note) {
            Swal.fire('แจ้งเตือน', 'กรุณาระบุสิ่งที่ต้องการให้แก้ไข', 'warning');
            return;
        }

        const confirm = await Swal.fire({
            title: 'ส่งกลับแก้ไข?',
            text: 'ผู้ขอซื้อจะได้รับการแจ้งเตือนเพื่อแก้ไขข้อมูล',
            icon: 'info',
            showCancelButton: true,
            confirmButtonColor: '#4f46e5',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'ส่งกลับ',
            cancelButtonText: 'ยกเลิก'
        });

        if (confirm.isConfirmed) {
            postAction('correction', note);
        }
    }

    async function postAction(action, note = '') {
        try {
            Swal.showLoading();
            let url = '';
            if (action === 'approve') url = `/api/orders/${orderId}/approve/`;
            else if (action === 'reject') url = `/api/orders/${orderId}/reject/`;
            else if (action === 'correction') url = `/api/orders/${orderId}/correction/`;
            
            // Note: In views.py we haven't created these specific endpoints yet, 
            // we will create them next.
            const res = await fetchAPI(url, {
                method: 'POST',
                body: JSON.stringify({ note: note })
            });

            if (res.ok) {
                Swal.fire('สำเร็จ', 'บันทึกเรียบร้อยแล้ว', 'success').then(() => {
                    window.location.reload();
                });
            } else {
                throw new Error('Action failed');
            }
        } catch (err) {
            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถดำเนินการได้', 'error');
        }
    }
</script>
{% endblock %}
