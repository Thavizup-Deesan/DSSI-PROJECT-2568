{% extends 'base.html' %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <a href="/api/projects/select/" class="text-sm text-gray-500 hover:text-indigo-600 mb-2 inline-block"><i class="fa-solid fa-arrow-left mr-1"></i> กลับไปเลือกโครงการ</a>
            <h1 class="text-2xl font-bold text-gray-800">สร้างใบขอซื้อใหม่</h1>
            <p class="text-gray-500 text-sm mt-1">โครงการ: <span id="projectNameDisplay" class="font-semibold text-indigo-600">กำลังโหลด...</span></p>
        </div>
        <div>
            <button onclick="submitOrder('Draft')" class="btn btn-ghost text-gray-500 mr-2">บันทึกร่าง</button>
            <button onclick="submitOrder('Pending')" class="btn btn-primary text-white shadow-lg shadow-indigo-200">
                <i class="fa-solid fa-paper-plane mr-2"></i> บันทึกและส่งขอซื้อ
            </button>
        </div>
    </div>

    <!-- Main Form -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hidden">
        <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Order Info: Title/Description/Vendor/Date removed as per request -->
            <!-- Keeping structure hidden just in case or simplifying completely -->
        </form>
    </div>
    
    <style>
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>

    <!-- Items Section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800">รายการสินค้า (Items)</h3>
            <div class="flex gap-2">

                <button type="button" onclick="addItemRow()" class="btn btn-sm btn-outline btn-primary">
                    <i class="fa-solid fa-plus mr-1"></i> เพิ่มรายการ
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="table w-full">
                <thead>
                    <tr class="bg-gray-50 text-gray-600">
                        <th class="w-10 text-center">#</th>
                        <th class="w-1/3">รายการ/ขนาด/ลักษณะ</th>
                        <th class="w-32 text-center">จำนวน</th>
                        <!-- Unit hidden/merged -->
                        <th class="w-32 text-right">ราคา/หน่วย</th>
                        <th class="w-32 text-right">รวมเงิน</th>
                        <th class="w-auto min-w-[200px]">ระบุเหตุผลการขอใช้ครุภัณฑ์</th>
                        <th class="w-10"></th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    <!-- Rows will be added here -->
                </tbody>
                <tfoot>
                    <tr class="font-bold text-lg bg-gray-50">
                        <td colspan="5" class="text-right">ยอดรวมทั้งสิ้น</td>
                        <td class="text-right text-indigo-600" id="grandTotalDisplay">0.00</td>
                        <td>บาท</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-10 text-gray-400">
            <i class="fa-solid fa-cart-shopping text-4xl mb-3"></i>
            <p>ยังไม่มีรายการสินค้า กดปุ่ม "เพิ่มรายการ" เพื่อเริ่ม</p>
        </div>
    </div>
    <!-- Shared Datalist -->
    <datalist id="product-suggestions"></datalist>

    <!-- JS State for products -->
    <script>
        let cachedProducts = [];
    </script>
</div>

<!-- Template for JS -->
<template id="itemRowTemplate">
    <tr class="hover:bg-gray-50 item-row">
        <td class="text-center index-cell pt-3">1</td>
        <td>
            <input type="text" 
                   class="border border-gray-300 rounded p-2 w-full item-name text-gray-900 bg-white" 
                   list="product-suggestions" 
                   oninput="handleProductInput(this)" 
                   placeholder="ระบุรายการ..." 
                   required />
        </td>
        <td>
            <input type="number" 
                   class="border border-gray-300 rounded p-2 w-full text-right font-bold text-gray-900 bg-white item-qty" 
                   value="1" min="1" 
                   oninput="calculateRow(this)" 
                   required />
            <input type="hidden" class="item-unit" value="ชิ้น">
        </td>
        <!-- Unit Column Removed from display -->
        <td>
            <input type="number" 
                   class="border border-gray-300 rounded p-2 w-full text-right font-bold text-gray-900 bg-white item-price" 
                   value="0" min="0" step="0.01" 
                   oninput="calculateRow(this)" 
                   required />
        </td>
        <td class="text-right font-mono item-total text-gray-900 text-lg font-bold pt-3">0.00</td>
        <td>
            <input type="text" 
                   class="border border-gray-300 rounded p-2 w-full item-reason text-gray-900 bg-white" 
                   placeholder="เหตุผล..." />
        </td>
        <td class="text-center">
            <button type="button" onclick="removeRow(this)" class="btn btn-ghost btn-xs text-red-500 hover:bg-red-50"><i class="fa-solid fa-trash"></i></button>
        </td>
    </tr>
</template>

{% endblock %}

{% block extra_js %}
<!-- SheetJS for Excel parsing -->

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('project_id');
    const projectName = localStorage.getItem('selected_project_name') || 'ไม่ระบุโครงการ';

    document.addEventListener('DOMContentLoaded', () => {
        if (!projectId) {
            Swal.fire({
                icon: 'warning',
                title: 'ไม่พบข้อมูลโครงการ',
                text: 'กรุณาเลือกโครงการก่อนทำรายการ'
            }).then(() => window.location.href = '/api/projects/select/');
            return;
        }
        document.getElementById('projectNameDisplay').textContent = projectName;
        
        // Add one initial row
        addItemRow();
    });

    function addItemRow() {
        const template = document.getElementById('itemRowTemplate');
        const clone = template.content.cloneNode(true);
        document.getElementById('itemsTableBody').appendChild(clone);
        
        updateIndexes();
        checkEmptyState();
    }



    function addItemRowWithData(name, qty, unit, price, reason) {
        const template = document.getElementById('itemRowTemplate');
        const clone = template.content.cloneNode(true);
        const row = clone.querySelector('tr');
        
        row.querySelector('.item-name').value = name;
        row.querySelector('.item-qty').value = qty;
        row.querySelector('.item-unit').value = unit;
        row.querySelector('.item-price').value = price;
        row.querySelector('.item-reason').value = reason;
        row.querySelector('.item-total').textContent = (qty * price).toLocaleString('en-US', {minimumFractionDigits: 2});
        
        document.getElementById('itemsTableBody').appendChild(clone);
        updateIndexes();
        checkEmptyState();
    }

    // Product Search & Autofill Logic
    let searchTimeout;

    async function handleProductInput(input) {
        const val = input.value;
        const row = input.closest('tr');
        
        // 1. Check if matches any cached product (Autofill)
        const match = cachedProducts.find(p => p.item_name === val);
        if (match) {
            row.querySelector('.item-unit').value = match.standard_unit || '';
            row.querySelector('.item-price').value = match.estimated_price || 0;
            calculateRow(row.querySelector('.item-qty'));
            return; // Exact match found, no need to search more
        }

        // 2. Debounce Search
        clearTimeout(searchTimeout);
        if (val.length < 2) return;

        searchTimeout = setTimeout(async () => {
            try {
                const res = await fetchAPI(`/api/products/?search=${encodeURIComponent(val)}`);
                if (res.ok) {
                    const products = await res.json();
                    cachedProducts = products; // Update cache
                    updateDatalist(products);
                }
            } catch (err) {
                console.error("Search failed", err);
            }
        }, 300);
    }

    function updateDatalist(products) {
        const datalist = document.getElementById('product-suggestions');
        datalist.innerHTML = '';
        products.forEach(p => {
            const option = document.createElement('option');
            option.value = p.item_name;
            // storing price in label is valid for display but value is what's put in input
            option.label = `${p.item_code || ''} - ${p.estimated_price} บาท`; 
            datalist.appendChild(option);
        });
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        updateIndexes();
        calculateGrandTotal();
        checkEmptyState();
    }

    function updateIndexes() {
        const rows = document.querySelectorAll('.item-row');
        rows.forEach((row, index) => {
            row.querySelector('.index-cell').textContent = index + 1;
        });
    }

    function checkEmptyState() {
        const rows = document.querySelectorAll('.item-row');
        const emptyState = document.getElementById('emptyState');
        if (rows.length === 0) {
            emptyState.classList.remove('hidden');
        } else {
            emptyState.classList.add('hidden');
        }
    }

    function calculateRow(input) {
        const row = input.closest('tr');
        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const total = qty * price;
        
        row.querySelector('.item-total').textContent = total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        calculateGrandTotal();
    }

    function calculateGrandTotal() {
        let grandTotal = 0;
        const rows = document.querySelectorAll('.item-row');
        rows.forEach(row => {
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            grandTotal += (qty * price);
        });
        
        document.getElementById('grandTotalDisplay').textContent = grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        return grandTotal;
    }

    async function submitOrder(status) {
        // const title = document.querySelector('input[name="order_title"]').value; // Removed
        // const requiredDate = document.querySelector('input[name="required_date"]').value; // Removed
        
        // Auto-set Date to Today if needed or leave empty
        const requiredDate = new Date().toISOString().split('T')[0]; 


        const items = [];
        const rows = document.querySelectorAll('.item-row');
        if (rows.length === 0) {
            Swal.fire('ไม่มีสินค้า', 'กรุณาเพิ่มรายการสินค้าอย่างน้อย 1 รายการ', 'warning');
            return;
        }

        rows.forEach(row => {
            items.push({
                item_name: row.querySelector('.item-name').value,
                quantity: parseFloat(row.querySelector('.item-qty').value),
                unit: row.querySelector('.item-unit').value || 'ชิ้น',
                estimated_unit_price: parseFloat(row.querySelector('.item-price').value),
                reason: row.querySelector('.item-reason').value || ''
            });
        });

        const user = JSON.parse(localStorage.getItem('user_info') || '{}');
        const total = calculateGrandTotal();

        const payload = {
            project_id: projectId,
            project_name: projectName,  // Include project name for printing
            requester_id: user.uid || user.id || 'unknown',
            requester_name: user.name || user.fullname || user.username || '-',  // Include requester name
            order_title: "ขอซื้อครุภัณฑ์",
            order_description: "-",
            vendor_name: "",
            required_date: requiredDate,
            items: items,
            total_estimated_price: total
        };

        try {
            // 1. Create Order First (it returns as Draft)
            Swal.fire({ title: 'กำลังบันทึก...', didOpen: () => Swal.showLoading() });
            
            const createRes = await fetchAPI('/api/orders/', {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const createData = await createRes.json();

            if (!createRes.ok) throw new Error(createData.error);

            // 2. If status is Pending (User wants to submit immediately), call submit API
            if (status === 'Pending') {
                const submitRes = await fetchAPI(`/api/orders/${createData.order_id}/submit/`, { method: 'POST' });
                const submitData = await submitRes.json();
                
                if (!submitRes.ok) throw new Error(submitData.error);
                
                Swal.fire({
                    icon: 'success',
                    title: 'ส่งใบขอซื้อเรียบร้อย',
                    text: 'กรุณารอการอนุมัติ',
                    timer: 2000
                }).then(() => window.location.href = '/api/orders/my/');
            } else {
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกร่างสำเร็จ',
                    timer: 1500
                }).then(() => window.location.href = '/api/orders/my/');
            }

        } catch (error) {
            Swal.fire('เกิดข้อผิดพลาด', error.message, 'error');
        }
    }
</script>
{% endblock %}
