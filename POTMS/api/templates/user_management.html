<!DOCTYPE html>
<html lang="th">
<!-- 
    ===================================================================
    user_management.html - หน้าจัดการผู้ใช้งาน (Admin Panel)
    ===================================================================
    ไฟล์นี้ใช้สำหรับ:
    - แสดงรายชื่อผู้ใช้ทั้งหมดในระบบ
    - แก้ไข Role และแผนกของผู้ใช้
    - ลบผู้ใช้ออกจากระบบ
    
    สิทธิ์การเข้าถึง:
    - เฉพาะ Admin เท่านั้น (ตรวจสอบจาก LocalStorage)
    
    เทคโนโลยีที่ใช้:
    - Tailwind CSS: สำหรับ styling
    - SweetAlert2: สำหรับแสดง popup แจ้งเตือน
    - Fetch API: สำหรับเรียก Backend APIs
    ===================================================================
-->

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>จัดการผู้ใช้งาน - POTMS</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
        <style>
                body {
                        font-family: 'Prompt', sans-serif;
                }
        </style>
</head>

<body class="bg-gray-50 text-gray-800">

        <!-- 
        ===================================================================
        Header - แถบด้านบน
        ===================================================================
    -->
        <header class="bg-white shadow-sm border-b border-gray-200">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                                <div class="bg-orange-500 p-2 rounded-lg text-white">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                        </svg>
                                </div>
                                <div>
                                        <h1 class="text-lg font-bold text-gray-800 leading-tight">จัดการผู้ใช้งาน</h1>
                                        <p class="text-xs text-gray-500">User Management (Admin Panel)</p>
                                </div>
                        </div>

                        <div class="flex items-center gap-4">
                                <div class="text-right hidden md:block">
                                        <p id="admin-name" class="text-sm font-semibold text-gray-700">Loading...</p>
                                        <p id="admin-role" class="text-xs text-gray-500">Admin</p>
                                </div>
                                <a href="/api/staff-dashboard/"
                                        class="flex items-center gap-1 text-gray-500 hover:text-gray-700 text-sm font-medium transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                        d="M11 17l-5-5m0 0l5-5m-5 5h12" />
                                        </svg>
                                        <span class="hidden md:inline">กลับหน้าหลัก</span>
                                </a>
                        </div>
                </div>
        </header>

        <!-- 
        ===================================================================
        Main Content - เนื้อหาหลัก
        ===================================================================
    -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

                <!-- Header Section -->
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
                        <div>
                                <h2 class="text-2xl font-bold text-gray-800">รายชื่อผู้ใช้งานทั้งหมด</h2>
                                <p class="text-gray-500 mt-1">จัดการบัญชีผู้ใช้ แก้ไขสิทธิ์ และลบผู้ใช้</p>
                        </div>

                        <!-- ปุ่มเพิ่มผู้ใช้ใหม่ -->
                        <a href="/api/register-page/"
                                class="mt-4 md:mt-0 inline-flex items-center gap-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 py-2 rounded-lg font-semibold hover:from-emerald-600 hover:to-teal-600 transition shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                                </svg>
                                เพิ่มผู้ใช้ใหม่
                        </a>
                </div>

                <!-- 
            ===================================================================
            ตารางแสดงรายชื่อผู้ใช้
            ===================================================================
        -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                        <tr>
                                                <th
                                                        class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        #</th>
                                                <th
                                                        class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        ชื่อผู้ใช้</th>
                                                <th
                                                        class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        ประเภท</th>
                                                <th
                                                        class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        แผนก</th>
                                                <th
                                                        class="px-6 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        จัดการ</th>
                                        </tr>
                                </thead>
                                <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- ข้อมูลจะถูกโหลดด้วย JavaScript -->
                                        <tr>
                                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                                        <div class="animate-pulse">กำลังโหลดข้อมูล...</div>
                                                </td>
                                        </tr>
                                </tbody>
                        </table>
                </div>

                <!-- สถิติผู้ใช้ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                                <p class="text-sm text-gray-500">ผู้ใช้ทั้งหมด</p>
                                <p id="stat-total" class="text-2xl font-bold text-gray-800">-</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                                <p class="text-sm text-gray-500">User</p>
                                <p id="stat-user" class="text-2xl font-bold text-blue-600">-</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                                <p class="text-sm text-gray-500">Staff</p>
                                <p id="stat-staff" class="text-2xl font-bold text-green-600">-</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                                <p class="text-sm text-gray-500">Admin</p>
                                <p id="stat-admin" class="text-2xl font-bold text-orange-600">-</p>
                        </div>
                </div>

        </main>

        <!-- 
        ===================================================================
        JavaScript - ฟังก์ชันจัดการข้อมูล
        ===================================================================
    -->
        <script>
                // ===================================================================
                // ตรวจสอบสิทธิ์การเข้าถึง (เฉพาะ Admin เท่านั้น)
                // ===================================================================
                const userStr = localStorage.getItem('user');
                if (!userStr) {
                        // ไม่ได้ Login -> ไปหน้า Login
                        window.location.href = '/api/login-page/';
                } else {
                        const user = JSON.parse(userStr);
                        document.getElementById('admin-name').innerText = user.username || 'Admin';
                        document.getElementById('admin-role').innerText = user.role;

                        // ตรวจสอบว่าเป็น Admin เท่านั้น (Staff ไม่สามารถเข้าถึงหน้านี้ได้)
                        if (user.role !== 'Admin') {
                                Swal.fire({
                                        icon: 'error',
                                        title: 'Access Denied',
                                        text: 'เฉพาะ Admin เท่านั้นที่สามารถเข้าถึงหน้านี้ได้',
                                        confirmButtonColor: '#f97316'
                                }).then(() => window.location.href = '/api/staff-dashboard/');
                        }
                }

                // ===================================================================
                // โหลดรายชื่อผู้ใช้จาก API
                // ===================================================================
                async function loadUsers() {
                        try {
                                const response = await fetch('/api/users/');
                                const users = await response.json();

                                const tbody = document.getElementById('users-table-body');

                                if (users.length === 0) {
                                        tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                ยังไม่มีผู้ใช้ในระบบ
                            </td>
                        </tr>
                    `;
                                        return;
                                }

                                // นับจำนวนแต่ละ Role สำหรับสถิติ
                                let countUser = 0, countStaff = 0, countAdmin = 0;

                                // สร้าง HTML สำหรับแต่ละแถว
                                tbody.innerHTML = users.map((user, index) => {
                                        // นับสถิติ
                                        if (user.role === 'User') countUser++;
                                        else if (user.role === 'Staff') countStaff++;
                                        else if (user.role === 'Admin') countAdmin++;

                                        // กำหนดสีตาม Role
                                        let roleClass = 'bg-blue-100 text-blue-800';
                                        if (user.role === 'Staff') roleClass = 'bg-green-100 text-green-800';
                                        else if (user.role === 'Admin') roleClass = 'bg-orange-100 text-orange-800';

                                        return `
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-3">
                                    <div class="h-10 w-10 rounded-full bg-gray-200 overflow-hidden">
                                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${user.username}" alt="Avatar" class="h-full w-full object-cover">
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold text-gray-800">${user.username}</p>
                                        <p class="text-xs text-gray-500">ID: ${user.id.substring(0, 8)}...</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 text-xs font-semibold rounded-full ${roleClass}">
                                    ${user.role}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${user.department || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <button onclick="editUser('${user.id}', '${user.username}', '${user.role}', '${user.department}')"
                                    class="text-blue-600 hover:text-blue-800 mx-1" title="แก้ไข">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button onclick="deleteUser('${user.id}', '${user.username}')"
                                    class="text-red-600 hover:text-red-800 mx-1" title="ลบ">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                                }).join('');

                                // อัปเดตสถิติ
                                document.getElementById('stat-total').innerText = users.length;
                                document.getElementById('stat-user').innerText = countUser;
                                document.getElementById('stat-staff').innerText = countStaff;
                                document.getElementById('stat-admin').innerText = countAdmin;

                        } catch (error) {
                                console.error('Error loading users:', error);
                                Swal.fire('Error', 'ไม่สามารถโหลดข้อมูลผู้ใช้ได้', 'error');
                        }
                }

                // ===================================================================
                // ฟังก์ชันแก้ไขผู้ใช้ (เปิด Popup Form)
                // ===================================================================
                async function editUser(userId, username, currentRole, currentDepartment) {
                        const { value: formValues } = await Swal.fire({
                                title: `แก้ไขข้อมูล: ${username}`,
                                html: `
                    <div class="text-left">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">ประเภทผู้ใช้</label>
                        <select id="swal-role" class="w-full px-3 py-2 border rounded-lg mb-4">
                            <option value="User" ${currentRole === 'User' ? 'selected' : ''}>User</option>
                            <option value="Staff" ${currentRole === 'Staff' ? 'selected' : ''}>Staff</option>
                            <option value="Admin" ${currentRole === 'Admin' ? 'selected' : ''}>Admin</option>
                        </select>
                        
                        <label class="block text-sm font-semibold text-gray-700 mb-1">แผนก/หน่วยงาน</label>
                        <input id="swal-department" class="w-full px-3 py-2 border rounded-lg" value="${currentDepartment || ''}">
                    </div>
                `,
                                focusConfirm: false,
                                showCancelButton: true,
                                confirmButtonText: 'บันทึก',
                                cancelButtonText: 'ยกเลิก',
                                confirmButtonColor: '#10b981',
                                preConfirm: () => {
                                        return {
                                                role: document.getElementById('swal-role').value,
                                                department: document.getElementById('swal-department').value
                                        }
                                }
                        });

                        if (formValues) {
                                try {
                                        const response = await fetch(`/api/users/${userId}/`, {
                                                method: 'PUT',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify(formValues)
                                        });

                                        const data = await response.json();

                                        if (response.ok) {
                                                Swal.fire('สำเร็จ', 'แก้ไขข้อมูลเรียบร้อยแล้ว', 'success');
                                                loadUsers(); // โหลดข้อมูลใหม่
                                        } else {
                                                Swal.fire('Error', data.error || 'แก้ไขไม่สำเร็จ', 'error');
                                        }
                                } catch (error) {
                                        Swal.fire('Error', 'ไม่สามารถเชื่อมต่อ Server ได้', 'error');
                                }
                        }
                }

                // ===================================================================
                // ฟังก์ชันลบผู้ใช้ (ยืนยันก่อนลบ)
                // ===================================================================
                async function deleteUser(userId, username) {
                        const result = await Swal.fire({
                                title: 'ยืนยันการลบ?',
                                text: `คุณต้องการลบผู้ใช้ "${username}" หรือไม่?`,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#ef4444',
                                cancelButtonColor: '#6b7280',
                                confirmButtonText: 'ลบเลย',
                                cancelButtonText: 'ยกเลิก'
                        });

                        if (result.isConfirmed) {
                                try {
                                        const response = await fetch(`/api/users/${userId}/`, {
                                                method: 'DELETE'
                                        });

                                        const data = await response.json();

                                        if (response.ok) {
                                                Swal.fire('ลบสำเร็จ', 'ลบผู้ใช้ออกจากระบบแล้ว', 'success');
                                                loadUsers(); // โหลดข้อมูลใหม่
                                        } else {
                                                Swal.fire('Error', data.error || 'ลบไม่สำเร็จ', 'error');
                                        }
                                } catch (error) {
                                        Swal.fire('Error', 'ไม่สามารถเชื่อมต่อ Server ได้', 'error');
                                }
                        }
                }

                // โหลดข้อมูลเมื่อหน้าเว็บโหลดเสร็จ
                loadUsers();
        </script>
</body>

</html>