{% extends 'base.html' %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">
    <div class="flex justify-between items-center">
        <div>
            <a href="/api/orders/my/" class="text-gray-500 hover:text-indigo-600 text-sm"><i class="fa-solid fa-arrow-left mr-1"></i> ยกเลิก</a>
            <h1 class="text-2xl font-bold text-gray-800 mt-1">แก้ไขใบขอซื้อ</h1>
        </div>
        <button onclick="saveAndResubmit()" class="btn btn-primary text-white">
            <i class="fa-solid fa-save mr-2"></i> บันทึกการแก้ไข
        </button>
    </div>

    <!-- Form Container -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <form id="editForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <input type="hidden" id="orderId" value="{{ order_id }}">
            


            <div class="form-control">
                <label class="label font-semibold">ร้านค้า</label>
                <input type="text" id="vendorName" class="input input-bordered focus:input-primary w-full" />
            </div>

            <div class="form-control">
                <label class="label font-semibold">วันที่ต้องการใช้</label>
                <input type="date" id="requiredDate" class="input input-bordered focus:input-primary w-full" />
            </div>

            <div class="form-control col-span-2">
                <label class="label font-semibold">รายละเอียดเพิ่มเติม</label>
                <textarea id="orderDesc" class="textarea textarea-bordered focus:textarea-primary w-full h-24"></textarea>
            </div>
        </form>
    </div>

    <!-- Items Section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-gray-800">รายการสินค้า</h3>
            <button onclick="addItemRow()" class="btn btn-sm btn-outline"><i class="fa-solid fa-plus"></i> เพิ่มรายการ</button>
        </div>
        
        <table class="table w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="w-12 text-center">#</th>
                    <th>รายการ</th>
                    <th class="w-24 text-right">จำนวน</th>
                    <th class="w-24 text-center">หน่วย</th>
                    <th class="w-32 text-right">ราคา/หน่วย</th>
                    <th class="w-32 text-right">รวมเงิน</th>
                    <th class="w-12"></th>
                </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
        </table>
    </div>
</div>

<!-- Template -->
<template id="itemRowTemplate">
    <tr class="hover:bg-gray-50 item-row">
        <td class="text-center index-cell">1</td>
        <td><input type="text" class="input input-sm input-bordered w-full item-name" required /></td>
        <td><input type="number" class="input input-sm input-bordered w-full text-right item-qty" oninput="calculateRow(this)" required /></td>
        <td><input type="text" class="input input-sm input-bordered w-full text-center item-unit" /></td>
        <td><input type="number" class="input input-sm input-bordered w-full text-right item-price" oninput="calculateRow(this)" required /></td>
        <td class="text-right font-mono item-total">0.00</td>
        <td class="text-center"><button type="button" onclick="removeRow(this)" class="btn btn-ghost btn-xs text-red-500"><i class="fa-solid fa-trash"></i></button></td>
    </tr>
</template>

{% endblock %}

{% block extra_js %}
<script>
    const orderId = document.getElementById('orderId').value;
    
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await fetchAPI(`/api/orders/${orderId}/`);
            if (!res.ok) throw new Error('Load failed');
            const data = await res.json();
            populateForm(data);
        } catch (err) {
            Swal.fire('Error', 'โหลดข้อมูลไม่สำเร็จ', 'error');
        }
    });

    function populateForm(data) {

        document.getElementById('vendorName').value = data.vendor_name;
        document.getElementById('requiredDate').value = data.required_date;
        document.getElementById('orderDesc').value = data.order_description;

        data.items.forEach(item => {
            addItemRow(item);
        });
    }

    function addItemRow(data = {}) {
        const template = document.getElementById('itemRowTemplate');
        const clone = template.content.cloneNode(true);
        
        clone.querySelector('.item-name').value = data.item_name || data.name || '';
        clone.querySelector('.item-qty').value = data.quantity || data.quantity_requested || 1;
        clone.querySelector('.item-unit').value = data.unit || '';
        clone.querySelector('.item-price').value = data.unit_price || data.estimated_unit_price || 0;
        
        document.getElementById('itemsBody').appendChild(clone);
        const lastRow = document.getElementById('itemsBody').lastElementChild;
        calculateRow(lastRow.querySelector('.item-qty')); // Initial calc
        updateIndexes();
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        updateIndexes();
    }

    function updateIndexes() {
        document.querySelectorAll('.item-row').forEach((row, i) => {
            row.querySelector('.index-cell').textContent = i + 1;
        });
    }

    function calculateRow(input) {
        const row = input.closest('tr');
        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        row.querySelector('.item-total').textContent = (qty * price).toLocaleString('en-US', {minimumFractionDigits: 2});
    }

    async function saveAndResubmit() {
        const items = [];
        let total = 0;
        
        document.querySelectorAll('.item-row').forEach(row => {
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            total += (qty * price);
            
            items.push({
                item_name: row.querySelector('.item-name').value,
                quantity: qty,
                unit: row.querySelector('.item-unit').value,
                estimated_unit_price: price
            });
        });

        const payload = {

            vendor_name: document.getElementById('vendorName').value,
            required_date: document.getElementById('requiredDate').value,
            order_description: document.getElementById('orderDesc').value,
            items: items,
            total_estimated_price: total
        };

        try {
            Swal.fire({ title: 'กำลังบันทึก...', didOpen: () => Swal.showLoading() });
            
            const res = await fetchAPI(`/api/orders/${orderId}/`, {
                method: 'PUT',
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                Swal.fire('สำเร็จ', 'บันทึกการแก้ไขเรียบร้อย', 'success').then(() => {
                    window.location.href = `/api/orders/${orderId}/view/`;
                });
            } else {
                throw new Error('Save failed');
            }
        } catch (err) {
            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกได้', 'error');
        }
    }
</script>
{% endblock %}
