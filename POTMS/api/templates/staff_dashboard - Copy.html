{% extends 'base.html' %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Staff Dashboard (เจ้าหน้าที่พัสดุ)</h1>
        <a href="/api/orders/create/" class="btn btn-primary text-white btn-sm">
            <i class="fa-solid fa-plus mr-1"></i> สร้างใบขอซื้อใหม่
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="stat bg-white shadow-sm rounded-xl border border-gray-100">
            <div class="stat-figure text-primary">
                <i class="fa-solid fa-file-invoice text-3xl"></i>
            </div>
            <div class="stat-title">รอตรวจสอบ</div>
            <div class="stat-value text-primary" id="count-pending">0</div>
            <div class="stat-desc">ใบขอซื้อใหม่ที่ส่งเข้ามา</div>
        </div>
        
        <div class="stat bg-white shadow-sm rounded-xl border border-gray-100">
            <div class="stat-figure text-yellow-500">
                <i class="fa-solid fa-signature text-3xl"></i>
            </div>
            <div class="stat-title">รออนุมัติ (ภาค/คณะ)</div>
            <div class="stat-value text-yellow-500" id="count-approving">0</div>
            <div class="stat-desc">อยู่ระหว่างกระบวนการอนุมัติ</div>
        </div>
        
        <div class="stat bg-white shadow-sm rounded-xl border border-gray-100">
            <div class="stat-figure text-info">
                <i class="fa-solid fa-truck text-3xl"></i>
            </div>
            <div class="stat-title">รอรับของ</div>
            <div class="stat-value text-info" id="count-receiving">0</div>
            <div class="stat-desc">PO ออกแล้ว / รอสินค้า</div>
        </div>

        <div class="stat bg-white shadow-sm rounded-xl border border-gray-100">
            <div class="stat-figure text-success">
                <i class="fa-solid fa-check-circle text-3xl"></i>
            </div>
            <div class="stat-title">ปิดงานแล้ว</div>
            <div class="stat-value text-success" id="count-completed">0</div>
            <div class="stat-desc">เดือนนี้</div>
        </div>
    </div>

    <!-- Incoming Orders Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-4 border-b border-gray-50 flex justify-between items-center">
            <h2 class="font-bold text-lg text-gray-800">รายการใบขอซื้อล่าสุด</h2>
            <div class="flex space-x-2">
                <select id="statusFilter" class="select select-sm select-bordered" onchange="loadOrders()">
                    <option value="">ทั้งหมด</option>
                    <option value="Pending" selected>รอตรวจสอบ (Pending)</option>
                    <option value="Approved">อนุมัติแล้ว (Approved)</option>
                    <option value="Rejected">ตีกลับ/ไม่อนุมัติ</option>
                </select>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="table w-full">
                <thead class="bg-gray-50 text-gray-600">
                    <tr>
                        <th>เลขที่เอกสาร</th>
                        <th>โครงการ</th>
                        <th>ผู้ขอซื้อ</th>
                        <th>วันที่ส่ง</th>
                        <th class="text-right">ยอดรวม</th>
                        <th class="text-center">สถานะ</th>
                        <th class="text-center">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body">
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-400">
                            <span class="loading loading-spinner loading-md"></span> กำลังโหลดข้อมูล...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadOrders();
        loadStats();
    });

    async function loadStats() {
        // In a real app, hit a stats endpoint. For now we might count client side or mock.
        // Assuming we add a stats endpoint later. 
        // For prototype, we'll leave as 0 or derive from list if small.
    }

    async function loadOrders() {
        const status = document.getElementById('statusFilter').value;
        const tbody = document.getElementById('orders-table-body');
        
        try {
            // Need a Staff API that ignores requester_id filter
            // Currently /api/orders/ filters by user token.
            // We need to implement a staff-specific fetch or update OrderAPIView to allow staff to see all.
            const res = await fetchAPI(`/api/orders/?staff_mode=true`); 
            if (!res.ok) throw new Error('API Error');
            
            let orders = await res.json();
            
            // Filter client side for now if API doesn't support status filter param yet
            if (status) {
                orders = orders.filter(o => o.status === status);
            }

            if (orders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-400">ไม่พบรายการใบขอซื้อ</td></tr>`;
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr class="hover:bg-gray-50 tr-link cursor-pointer" onclick="window.location.href='/api/orders/${order.id}/view/'">
                    <td class="font-mono font-medium">${order.order_no || '-'}</td>
                    <td>
                        <div class="font-bold text-sm">${order.project_code}</div>
                        <div class="text-xs text-gray-500 truncate w-48">${order.project_name}</div>
                    </td>
                    <td>
                        <div class="text-sm">${order.requester_name || '-'}</div>
                    </td>
                    <td class="text-sm text-gray-500">${order.created_at ? new Date(order.created_at).toLocaleDateString('th-TH') : '-'}</td>
                    <td class="text-right font-mono font-bold">${(order.total_estimated_price || 0).toLocaleString()}</td>
                    <td class="text-center">
                        <span class="badge ${getStatusBadge(order.status)} badge-sm">${order.status}</span>
                    </td>
                    <td class="text-center" onclick="event.stopPropagation()">
                        <a href="/api/orders/${order.id}/view/" class="btn btn-ghost btn-xs text-primary">ตรวจสอบ</a>
                    </td>
                </tr>
            `).join('');
            
            // Update stats from loaded data (mocking the stats logic for now)
            document.getElementById('count-pending').textContent = orders.filter(o => o.status === 'Pending').length;
            
        } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-red-500">โหลดข้อมูลไม่สำเร็จ</td></tr>`;
        }
    }

    function getStatusBadge(status) {
        switch(status) {
            case 'Draft': return 'badge-ghost';
            case 'Pending': return 'badge-warning';
            case 'Approved': return 'badge-success';
            case 'Rejected': return 'badge-error';
            default: return 'badge-outline';
        }
    }
</script>
{% endblock %}
