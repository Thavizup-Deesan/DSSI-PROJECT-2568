<!DOCTYPE html>
<html lang="th">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>รายการใบขอซื้อรอการอนุมัติ - POTMS</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap"
                rel="stylesheet">
        <style>
                body {
                        font-family: 'Prompt', sans-serif;
                }
        </style>
</head>

<body class="bg-gray-50 min-h-screen">

        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-cyan-500 text-white py-3 sm:py-4 shadow-lg">
                <div
                        class="max-w-7xl mx-auto px-4 sm:px-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0">
                        <div class="flex items-center gap-2 sm:gap-3">
                                <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h1 class="text-base sm:text-xl font-bold">ระบบจัดการติดตามการสั่งซื้อของโครงการ</h1>
                        </div>
                        <div class="flex items-center gap-3 text-sm">
                                <span id="staffName" class="hidden sm:inline">สำหรับ: Staff</span>
                                <button onclick="logout()" class="hover:underline">ออกจากระบบ</button>
                        </div>
                </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-8">

                <!-- Page Header -->
                <div class="mb-4 sm:mb-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                                <div>
                                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">รายการใบขอซื้อรอการอนุมัติ</h2>
                                        <p class="text-xs sm:text-sm text-gray-600 mt-1">
                                                ตรวจสอบและอนุมัติรายการขอซื้อจากผู้ใช้งานทั้งหมดในระบบ</p>
                                </div>
                                <a href="/api/staff-dashboard/"
                                        class="text-blue-600 hover:underline flex items-center gap-2 text-sm">
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                        </svg>
                                        <span class="hidden sm:inline">กลับหน้าหลัก</span>
                                        <span class="sm:hidden">กลับ</span>
                                </a>
                        </div>
                </div>

                <!-- Breadcrumb Navigation -->
                <div id="breadcrumb" class="mb-4 flex items-center gap-2 text-sm text-gray-600">
                        <span id="breadcrumb-projects" class="text-blue-600 font-medium">รายการโครงการ</span>
                        <span id="breadcrumb-separator" class="hidden">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                        </span>
                        <span id="breadcrumb-orders" class="hidden font-medium text-gray-800"></span>
                </div>

                <!-- Projects View -->
                <div id="projectsView" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-100">
                                <h3 class="font-semibold text-gray-800">รายการโครงการที่มีใบขอซื้อ</h3>
                                <p id="projectCount" class="text-sm text-gray-500">พบ 0 โครงการ</p>
                        </div>

                        <!-- Loading -->
                        <div id="loadingProjects" class="text-center py-10">
                                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
                                <p class="mt-2 text-gray-500">กำลังโหลดข้อมูล...</p>
                        </div>

                        <!-- Projects Grid -->
                        <div id="projectsGrid" class="p-4 sm:p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 hidden"></div>

                        <!-- Empty State -->
                        <div id="emptyProjects" class="text-center py-10 hidden">
                                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <p class="text-gray-500">ไม่มีโครงการที่มีใบขอซื้อ</p>
                        </div>
                </div>

                <!-- Orders View (Initially Hidden) -->
                <div id="ordersView" class="hidden">
                        <!-- Back Button -->
                        <button onclick="showProjectsView()" class="mb-4 flex items-center gap-2 text-blue-600 hover:text-blue-800 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                                กลับไปรายการโครงการ
                        </button>

                        <!-- Filter Section -->
                        <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-4 sm:mb-6 border border-gray-100">
                                <h3 class="font-semibold text-gray-800 mb-3 sm:mb-4 text-sm sm:text-base">
                                        เครื่องมือค้นหาและเลือกรอง</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
                                        <!-- Search by Order No -->
                                        <div>
                                                <label class="block text-xs sm:text-sm text-gray-600 mb-1">ค้นหาตามเลขใบขอซื้อ</label>
                                                <input type="text" id="searchOrderNo" placeholder="ค้นหาเลขใบขอซื้อ"
                                                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                        </div>

                                        <!-- Date From -->
                                        <div>
                                                <label class="block text-xs sm:text-sm text-gray-600 mb-1">กรองตามช่วงเวลา</label>
                                                <input type="date" id="dateFrom"
                                                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                        </div>

                                        <!-- Date To -->
                                        <div>
                                                <label class="block text-xs sm:text-sm text-gray-600 mb-1">ถึง</label>
                                                <input type="date" id="dateTo"
                                                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                        </div>

                                        <!-- Status Filter -->
                                        <div>
                                                <label class="block text-xs sm:text-sm text-gray-600 mb-1">สถานะ</label>
                                                <select id="statusFilter" onchange="filterOrders()"
                                                        class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                                        <option value="" selected>ทั้งหมด</option>
                                                        <option value="Draft">ฉบับร่าง</option>
                                                        <option value="Pending">รออนุมัติ</option>
                                                        <option value="WaitingBossApproval">รอหัวหน้าเซ็น</option>
                                                        <option value="Approved">หัวหน้าอนุมัติแล้ว</option>
                                                        <option value="CorrectionNeeded">ต้องแก้ไข</option>
                                                        <option value="Rejected">ปฏิเสธ</option>
                                                        <option value="SentToProcurement">ส่งพัสดุแล้ว</option>
                                                        <option value="ReceivedFromProcurement">รับของจากพัสดุแล้ว</option>
                                                        <option value="WaitingInspection">รอตรวจรับ</option>
                                                        <option value="Inspected">ตรวจรับแล้ว</option>
                                                        <option value="Closed">ปิดแล้ว</option>
                                                </select>
                                        </div>
                                </div>

                                <!-- Search Button -->
                                <div class="mt-3 sm:mt-4 flex justify-end">
                                        <button onclick="filterOrders()"
                                                class="w-full sm:w-auto px-4 sm:px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium text-sm">
                                                ค้นหา
                                        </button>
                                </div>
                        </div>

                        <!-- Orders Table -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                                <!-- Table Header -->
                                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                                        <div>
                                                <h3 id="ordersTableTitle" class="font-semibold text-gray-800">รายการขอซื้อ</h3>
                                                <p id="orderCount" class="text-sm text-gray-500">พบ 0 รายการ</p>
                                        </div>
                                </div>

                                <!-- Loading -->
                                <div id="loadingOrders" class="text-center py-10 hidden">
                                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
                                        <p class="mt-2 text-gray-500">กำลังโหลดข้อมูล...</p>
                                </div>

                                <!-- Table -->
                                <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                        <tr>
                                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">
                                                                        เลขใบขอซื้อ</th>
                                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">
                                                                        วันที่ขอซื้อ</th>
                                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">
                                                                        เรื่อง</th>
                                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">
                                                                        ชื่อผู้ขอ</th>
                                                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">
                                                                        สถานะ</th>
                                                                <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase">
                                                                        ยอดเงินรวม</th>
                                                                <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase">
                                                                        การจัดการ</th>
                                                        </tr>
                                                </thead>
                                                <tbody id="ordersTable" class="bg-white divide-y divide-gray-200">
                                                        <!-- Rows will be inserted here -->
                                                </tbody>
                                        </table>
                                </div>

                                <!-- Empty State -->
                                <div id="emptyOrders" class="text-center py-10 hidden">
                                        <p class="text-gray-500">ไม่พบรายการใบขอซื้อ</p>
                                </div>

                                <!-- Pagination -->
                                <div id="pagination" class="px-6 py-4 border-t border-gray-100 flex justify-between items-center hidden">
                                        <p id="pageInfo" class="text-sm text-gray-600">แสดง 1-5 จาก 7 รายการ</p>
                                        <div class="flex gap-2">
                                                <button onclick="previousPage()"
                                                        class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50">
                                                        &lt;
                                                </button>
                                                <button class="px-3 py-1 bg-cyan-500 text-white rounded">1</button>
                                                <button onclick="nextPage()"
                                                        class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50">
                                                        &gt;
                                                </button>
                                        </div>
                                </div>
                        </div>
                </div>

        </main>

        <script>
                // ===================================================================
                // Global Variables
                // ===================================================================
                let allOrders = [];
                let projectsWithOrders = [];
                let currentProjectId = null;
                let currentProjectName = '';
                let filteredOrders = [];

                // ===================================================================
                // Initialize
                // ===================================================================
                document.addEventListener('DOMContentLoaded', async () => {
                        // Check if user is staff
                        const user = JSON.parse(localStorage.getItem('user') || '{}');
                        if ((user.role || '').toLowerCase() !== 'staff') {
                                Swal.fire('Error', 'คุณไม่มีสิทธิ์เข้าถึงหน้านี้', 'error')
                                        .then(() => window.location.href = '/api/login-page/');
                                return;
                        }

                        document.getElementById('staffName').textContent = `สำหรับ: ${user.fullname || 'Staff'}`;
                        await loadProjectsWithOrders();
                });

                // ===================================================================
                // Load Projects with Orders
                // ===================================================================
                async function loadProjectsWithOrders() {
                        try {
                                // Load all orders first
                                const res = await fetch('/api/staff/orders/');
                                if (!res.ok) throw new Error('ไม่สามารถโหลดข้อมูลได้');
                                
                                allOrders = await res.json();

                                // Group orders by project
                                const projectMap = new Map();
                                
                                for (const order of allOrders) {
                                        const projectId = order.project_id;
                                        if (!projectId) continue;
                                        
                                        if (!projectMap.has(projectId)) {
                                                projectMap.set(projectId, {
                                                        project_id: projectId,
                                                        orders: [],
                                                        total_amount: 0,
                                                        pending_count: 0,
                                                        project_name: null  // Will load separately
                                                });
                                        }
                                        
                                        const project = projectMap.get(projectId);
                                        project.orders.push(order);
                                        project.total_amount += parseFloat(order.total_estimated_price || 0);
                                        
                                        // Count pending orders
                                        if (['Pending', 'WaitingBossApproval'].includes(order.status)) {
                                                project.pending_count++;
                                        }
                                }

                                projectsWithOrders = Array.from(projectMap.values());

                                // Load project names
                                await loadProjectNames();

                                // Render projects
                                renderProjects();

                        } catch (e) {
                                console.error('Error loading projects:', e);
                                document.getElementById('loadingProjects').classList.add('hidden');
                                document.getElementById('emptyProjects').classList.remove('hidden');
                        }
                }

                // ===================================================================
                // Load Project Names
                // ===================================================================
                async function loadProjectNames() {
                        const promises = projectsWithOrders.map(async (project) => {
                                try {
                                        const res = await fetch(`/api/projects/${project.project_id}/`);
                                        if (res.ok) {
                                                const data = await res.json();
                                                project.project_name = data.project_name || data.project_code || `โครงการ ${project.project_id.slice(-4).toUpperCase()}`;
                                                project.project_code = data.project_code || '';
                                                project.budget_total = data.budget_total || 0;
                                        }
                                } catch (e) {
                                        project.project_name = `โครงการ ${project.project_id.slice(-4).toUpperCase()}`;
                                }
                        });
                        
                        await Promise.all(promises);
                }

                // ===================================================================
                // Render Projects Grid
                // ===================================================================
                function renderProjects() {
                        const grid = document.getElementById('projectsGrid');
                        const loading = document.getElementById('loadingProjects');
                        const empty = document.getElementById('emptyProjects');
                        const count = document.getElementById('projectCount');

                        loading.classList.add('hidden');

                        if (projectsWithOrders.length === 0) {
                                empty.classList.remove('hidden');
                                grid.classList.add('hidden');
                                count.textContent = 'พบ 0 โครงการ';
                                return;
                        }

                        empty.classList.add('hidden');
                        grid.classList.remove('hidden');
                        count.textContent = `พบ ${projectsWithOrders.length} โครงการ`;

                        grid.innerHTML = projectsWithOrders.map(project => `
                                <div onclick="viewProjectOrders('${project.project_id}', '${escapeHtml(project.project_name)}')" 
                                        class="bg-gradient-to-br from-white to-gray-50 rounded-xl p-5 border border-gray-200 hover:border-blue-400 hover:shadow-lg transition-all cursor-pointer group">
                                        
                                        <!-- Project Header -->
                                        <div class="flex items-start justify-between mb-4">
                                                <div class="flex items-center gap-3">
                                                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center group-hover:bg-blue-200 transition">
                                                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                                                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                                                </svg>
                                                        </div>
                                                        <div>
                                                                <h4 class="font-semibold text-gray-800 group-hover:text-blue-600 transition line-clamp-1">
                                                                        ${escapeHtml(project.project_name)}
                                                                </h4>
                                                                ${project.project_code ? `<p class="text-xs text-gray-500">${escapeHtml(project.project_code)}</p>` : ''}
                                                        </div>
                                                </div>
                                                ${project.pending_count > 0 ? `
                                                        <span class="bg-red-100 text-red-600 text-xs font-semibold px-2 py-1 rounded-full">
                                                                ${project.pending_count} รออนุมัติ
                                                        </span>
                                                ` : ''}
                                        </div>

                                        <!-- Stats -->
                                        <div class="grid grid-cols-2 gap-3">
                                                <div class="bg-blue-50 rounded-lg p-3 text-center">
                                                        <p class="text-2xl font-bold text-blue-600">${project.orders.length}</p>
                                                        <p class="text-xs text-gray-600">ใบขอซื้อ</p>
                                                </div>
                                                <div class="bg-green-50 rounded-lg p-3 text-center">
                                                        <p class="text-lg font-bold text-green-600">${formatNumber(project.total_amount)}</p>
                                                        <p class="text-xs text-gray-600">บาท</p>
                                                </div>
                                        </div>

                                        <!-- View Button -->
                                        <div class="mt-4 flex justify-end">
                                                <span class="text-blue-600 text-sm font-medium flex items-center gap-1 group-hover:gap-2 transition-all">
                                                        ดูรายการใบขอซื้อ
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                        </svg>
                                                </span>
                                        </div>
                                </div>
                        `).join('');
                }

                // ===================================================================
                // View Project Orders
                // ===================================================================
                function viewProjectOrders(projectId, projectName) {
                        currentProjectId = projectId;
                        currentProjectName = projectName;

                        // Update breadcrumb
                        document.getElementById('breadcrumb-projects').className = 'text-blue-600 hover:underline cursor-pointer';
                        document.getElementById('breadcrumb-projects').onclick = showProjectsView;
                        document.getElementById('breadcrumb-separator').classList.remove('hidden');
                        document.getElementById('breadcrumb-orders').classList.remove('hidden');
                        document.getElementById('breadcrumb-orders').textContent = projectName;

                        // Switch views
                        document.getElementById('projectsView').classList.add('hidden');
                        document.getElementById('ordersView').classList.remove('hidden');

                        // Update title
                        document.getElementById('ordersTableTitle').textContent = `รายการขอซื้อ - ${projectName}`;

                        // Filter and render orders
                        filterOrders();
                }

                // ===================================================================
                // Show Projects View
                // ===================================================================
                function showProjectsView() {
                        currentProjectId = null;
                        currentProjectName = '';

                        // Reset breadcrumb
                        document.getElementById('breadcrumb-projects').className = 'text-blue-600 font-medium';
                        document.getElementById('breadcrumb-projects').onclick = null;
                        document.getElementById('breadcrumb-separator').classList.add('hidden');
                        document.getElementById('breadcrumb-orders').classList.add('hidden');

                        // Switch views
                        document.getElementById('projectsView').classList.remove('hidden');
                        document.getElementById('ordersView').classList.add('hidden');
                }

                // ===================================================================
                // Filter Orders by Current Project
                // ===================================================================
                function filterOrders() {
                        if (!currentProjectId) return;

                        // Get orders for current project
                        let projectOrders = allOrders.filter(order => order.project_id === currentProjectId);

                        // Apply search filter
                        const searchText = document.getElementById('searchOrderNo').value.toLowerCase();
                        if (searchText) {
                                projectOrders = projectOrders.filter(order =>
                                        (order.order_no || '').toLowerCase().includes(searchText)
                                );
                        }

                        // Apply status filter
                        const statusFilter = document.getElementById('statusFilter').value;
                        if (statusFilter) {
                                projectOrders = projectOrders.filter(order => order.status === statusFilter);
                        }

                        // Apply date filters
                        const dateFrom = document.getElementById('dateFrom').value;
                        const dateTo = document.getElementById('dateTo').value;

                        if (dateFrom) {
                                projectOrders = projectOrders.filter(order => {
                                        const orderDate = order.created_at._seconds
                                                ? new Date(order.created_at._seconds * 1000)
                                                : new Date(order.created_at);
                                        return orderDate >= new Date(dateFrom);
                                });
                        }

                        if (dateTo) {
                                projectOrders = projectOrders.filter(order => {
                                        const orderDate = order.created_at._seconds
                                                ? new Date(order.created_at._seconds * 1000)
                                                : new Date(order.created_at);
                                        return orderDate <= new Date(dateTo + 'T23:59:59');
                                });
                        }

                        filteredOrders = projectOrders;
                        renderOrdersTable(filteredOrders);
                }

                // ===================================================================
                // Render Orders Table
                // ===================================================================
                function renderOrdersTable(orders) {
                        const tbody = document.getElementById('ordersTable');
                        const empty = document.getElementById('emptyOrders');
                        const pagination = document.getElementById('pagination');
                        const count = document.getElementById('orderCount');

                        tbody.innerHTML = '';

                        if (orders.length === 0) {
                                empty.classList.remove('hidden');
                                pagination.classList.add('hidden');
                                count.textContent = 'พบ 0 รายการ';
                                return;
                        }

                        empty.classList.add('hidden');
                        pagination.classList.remove('hidden');
                        count.textContent = `พบ ${orders.length} รายการ`;

                        orders.forEach(order => {
                                const row = document.createElement('tr');
                                row.className = 'hover:bg-gray-50';

                                // Format date
                                const createdDate = order.created_at._seconds
                                        ? new Date(order.created_at._seconds * 1000)
                                        : new Date(order.created_at);
                                const dateStr = createdDate.toLocaleDateString('th-TH');
                                const timeStr = createdDate.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

                                // Status badge
                                const statusBadge = getStatusBadge(order.status);

                                row.innerHTML = `
                                        <td class="px-6 py-4">
                                                <span class="text-blue-600 font-medium">${order.order_no || order.id.slice(-6).toUpperCase()}</span>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${dateStr} ${timeStr}</td>
                                        <td class="px-6 py-4 text-sm text-gray-800">${escapeHtml(order.order_title || order.order_description || '-')}</td>
                                        <td class="px-6 py-4 text-sm text-gray-600" id="requester-${order.id}">กำลังโหลด...</td>
                                        <td class="px-6 py-4">
                                                ${statusBadge}
                                        </td>
                                        <td class="px-6 py-4 text-sm text-right font-medium text-gray-800">
                                                ${(order.total_estimated_price || 0).toLocaleString()} บาท
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                                <button onclick="viewOrder('${order.id}')"
                                                        class="px-4 py-2 bg-cyan-500 text-white text-sm rounded-lg hover:bg-cyan-600 transition">
                                                        ตรวจสอบ
                                                </button>
                                        </td>
                                `;
                                tbody.appendChild(row);

                                // Load requester name
                                loadRequesterName(order.requester_id, order.id);
                        });

                        // Update page info
                        document.getElementById('pageInfo').textContent = `แสดง 1-${orders.length} จาก ${orders.length} รายการ`;
                }

                // ===================================================================
                // Get Status Badge HTML
                // ===================================================================
                function getStatusBadge(status) {
                        const statusMap = {
                                'Draft': { text: 'ฉบับร่าง', class: 'bg-gray-100 text-gray-600' },
                                'Pending': { text: 'รออนุมัติ', class: 'bg-yellow-100 text-yellow-700' },
                                'WaitingBossApproval': { text: 'รอหัวหน้าเซ็น', class: 'bg-purple-100 text-purple-700' },
                                'Approved': { text: 'อนุมัติแล้ว', class: 'bg-green-100 text-green-700' },
                                'CorrectionNeeded': { text: 'ต้องแก้ไข', class: 'bg-orange-100 text-orange-700' },
                                'Rejected': { text: 'ปฏิเสธ', class: 'bg-red-100 text-red-700' },
                                'SentToProcurement': { text: 'ส่งพัสดุแล้ว', class: 'bg-indigo-100 text-indigo-700' },
                                'ReceivedFromProcurement': { text: 'รับของแล้ว', class: 'bg-blue-100 text-blue-700' },
                                'WaitingInspection': { text: 'รอตรวจรับ', class: 'bg-amber-100 text-amber-700' },
                                'Inspected': { text: 'ตรวจรับแล้ว', class: 'bg-teal-100 text-teal-700' },
                                'Closed': { text: 'ปิดแล้ว', class: 'bg-gray-200 text-gray-600' }
                        };

                        const statusInfo = statusMap[status] || { text: status || '-', class: 'bg-gray-100 text-gray-600' };
                        return `<span class="px-3 py-1 text-xs font-semibold rounded-full ${statusInfo.class}">${statusInfo.text}</span>`;
                }

                // ===================================================================
                // Load Requester Name
                // ===================================================================
                async function loadRequesterName(userId, orderId) {
                        try {
                                const res = await fetch(`/api/users/${userId}/`);
                                const user = await res.json();
                                const el = document.getElementById(`requester-${orderId}`);
                                if (el) el.textContent = user.fullname || user.username || '-';
                        } catch (e) {
                                const el = document.getElementById(`requester-${orderId}`);
                                if (el) el.textContent = '-';
                        }
                }

                // ===================================================================
                // View Order Detail
                // ===================================================================
                function viewOrder(orderId) {
                        window.location.href = `/api/staff/orders/${orderId}/detail/`;
                }

                // ===================================================================
                // Helper Functions
                // ===================================================================
                function formatNumber(num) {
                        if (num >= 1000000) {
                                return (num / 1000000).toFixed(1) + 'M';
                        } else if (num >= 1000) {
                                return (num / 1000).toFixed(1) + 'K';
                        }
                        return num.toLocaleString();
                }

                function escapeHtml(text) {
                        if (!text) return '';
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                }

                // Pagination
                function previousPage() {
                        Swal.fire('Info', 'Pagination จะพัฒนาในระยะต่อไป', 'info');
                }

                function nextPage() {
                        Swal.fire('Info', 'Pagination จะพัฒนาในระยะต่อไป', 'info');
                }

                // Logout
                function logout() {
                        localStorage.removeItem('user');
                        window.location.href = '/api/login-page/';
                }
        </script>
</body>

</html>