{% extends "base.html" %}
{% block title %}ใบสั่งซื้อของฉัน{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold">ใบสั่งซื้อของฉัน</h1>
        <p class="text-sm text-base-content/50">แยกตามโครงการ</p>
    </div>
    <div class="flex gap-2">
        <div id="projectNavControls" class="hidden">
            <button class="btn btn-ghost btn-sm gap-2" onclick="showProjectGrid()">
                <span class="material-icons-outlined text-base">arrow_back</span> กลับไปเลือกโครงการ
            </button>
        </div>
        <a href="/orders/create/" class="btn btn-primary btn-sm gap-2">
            <span class="material-icons-outlined text-base">add</span> สร้างใบสั่งซื้อ
        </a>
    </div>
</div>

<!-- Project Grid View -->
<div id="projectGridView">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="projectGrid">
        <!-- Project Cards will be injected here -->
    </div>
</div>

<!-- Order List View (Hidden by default) -->
<div id="orderListView" class="hidden">
    <div class="card bg-base-200 border border-base-content/5 mb-4">
        <div class="card-body py-3">
            <div class="flex gap-3 flex-wrap items-center justify-between">
                <h2 class="text-lg font-bold" id="selectedProjectName">ชื่อโครงการ</h2>
            </div>
        </div>
    </div>

    <div class="card bg-base-200 border border-base-content/5">
        <div class="card-body">
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead><tr><th>เลขที่</th><th>จำนวนเงิน</th><th>รายการ</th><th>สถานะ</th><th>วันที่สร้าง</th><th>การดำเนินการ</th></tr></thead>
                    <tbody id="ordersTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentOrders = [];
    let projectsMap = {};

    async function loadProjects() {
        // User sees only their projects (API filtered)
        const projects = await apiFetch('/api/projects/');
        const grid = document.getElementById('projectGrid');
        
        if (projects.length === 0) {
            grid.innerHTML = `<div class="col-span-full text-center py-10 opacity-50">คุณยังไม่มีโครงการที่รับผิดชอบ</div>`;
            return;
        }

        grid.innerHTML = projects.map(p => {
            projectsMap[p.project_id] = p;
            return `
            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-all border border-base-content/10 cursor-pointer group"
                 onclick="loadOrders(${p.project_id})">
                <div class="card-body p-6">
                    <div class="flex justify-between items-start">
                        <div class="p-3 rounded-xl bg-secondary/10 text-secondary group-hover:bg-secondary group-hover:text-white transition-colors">
                            <span class="material-icons-outlined text-3xl">topic</span>
                        </div>
                        ${getStatusBadge(p.status)}
                    </div>
                    <h3 class="card-title mt-4 text-lg group-hover:text-secondary transition-colors">${p.project_name}</h3>
                    <div class="text-sm opacity-60 mt-1">งบคงเหลือ: ฿${parseFloat(p.remaining_budget).toLocaleString()}</div>
                </div>
            </div>
            `;
        }).join('');
    }

    async function loadOrders(projectId) {
        document.getElementById('projectGridView').classList.add('hidden');
        document.getElementById('orderListView').classList.remove('hidden');
        document.getElementById('projectNavControls').classList.remove('hidden');
        
        const project = projectsMap[projectId];
        document.getElementById('selectedProjectName').textContent = project ? project.project_name : 'ใบสั่งซื้อในโครงการ';

        // Fetch orders (API filters for user)
        const orders = await apiFetch(`/api/orders/?project_id=${projectId}`);
        currentOrders = orders;
        renderOrders(orders);
    }

    function renderOrders(orders) {
        const tbody = document.getElementById('ordersTable');
        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-base-content/40 py-8">คุณยังไม่มีใบสั่งซื้อในโครงการนี้</td></tr>';
            return;
        }
        tbody.innerHTML = orders.map(o => `
            <tr class="hover">
                <td><a href="/orders/detail/?id=${o.order_id}" class="link link-primary font-medium">${o.order_no}</a></td>
                <td>฿${parseFloat(o.total_amount).toLocaleString()}</td>
                <td>${o.items_count} รายการ</td>
                <td>${getStatusBadge(o.status)}</td>
                <td class="text-sm opacity-60">${new Date(o.created_at).toLocaleDateString('th-TH')}</td>
                <td>
                    <a href="/orders/detail/?id=${o.order_id}" class="btn btn-ghost btn-xs">ดู</a>
                    ${['Draft','Rejected'].includes(o.status) ? `<a href="/orders/edit/?id=${o.order_id}" class="btn btn-outline btn-xs">แก้ไข</a>` : ''}
                </td>
            </tr>
        `).join('');
    }

    function showProjectGrid() {
        document.getElementById('orderListView').classList.add('hidden');
        document.getElementById('projectNavControls').classList.add('hidden');
        document.getElementById('projectGridView').classList.remove('hidden');
        currentOrders = [];
    }

    // Initialize
    loadProjects();
</script>
{% endblock %}
