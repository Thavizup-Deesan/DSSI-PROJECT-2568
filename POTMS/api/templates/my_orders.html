{% extends 'base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6 px-4 md:px-0">
    <div class="flex justify-between items-end">
        <div>
            <div class="flex items-center space-x-2 mb-2">
                <a href="/api/dashboard/" class="text-gray-500 hover:text-indigo-600 text-sm">
                    <i class="fa-solid fa-arrow-left mr-1"></i> กลับหน้าหลัก
                </a>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                รายการใบขอซื้อพัสดุ
            </h1>
            <p class="text-gray-500 text-sm mt-1">ติดตามสถานะและประวัติการสั่งซื้อพัสดุ</p>
        </div>
        
        <!-- Status Filter -->
        <div class="flex space-x-2">
            <button class="btn btn-sm btn-active" onclick="filterStatus('all')">ทั้งหมด</button>
            <button class="btn btn-sm btn-ghost" onclick="filterStatus('Draft')">ร่าง</button>
            <button class="btn btn-sm btn-ghost" onclick="filterStatus('Pending')">รออนุมัติ</button>
            <button class="btn btn-sm btn-ghost" onclick="filterStatus('Approved')">อนุมัติแล้ว</button>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="table w-full whitespace-nowrap">
                <thead class="bg-gray-50 text-gray-600">
                    <tr>
                        <th class="w-16 text-center">#</th>
                        <th>เลขที่ใบขอซื้อ</th>
                        <th>โครงการ</th>
                        <th>วันที่สร้าง</th>
                        <th>ยอดรวม</th>
                        <th class="text-center">สถานะ</th>
                        <th class="text-center">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr>
                        <td colspan="6" class="text-center py-10 text-gray-400">
                            <span class="loading loading-spinner text-primary"></span> กำลังโหลดข้อมูล...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let allOrders = [];
    // user is already declared in base.html

    document.addEventListener('DOMContentLoaded', () => {
        // โหลดรายการอัตโนมัติเมื่อเปิดหน้า
        loadOrders();
    });

    function showEmptyState() {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-10 text-gray-400">
                    <div class="space-y-3">
                        <i class="fa-solid fa-folder-open text-4xl text-gray-300"></i>
                        <p>กดปุ่มด้านบนเพื่อดูรายการใบขอซื้อ</p>
                        <button onclick="loadOrders()" class="btn btn-primary btn-sm text-white">
                            <i class="fa-solid fa-sync mr-1"></i> โหลดรายการ
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }

    async function loadOrders() {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-10"><span class="loading loading-spinner"></span> กำลังโหลด...</td></tr>`;
        
        try {
            // Force filter for Supplies (พัสดุ)
            const response = await fetchAPI(`/api/orders/?type=พัสดุ&user_id=${user ? user.uid : ''}`);
            allOrders = await response.json();
            console.log('API Response:', allOrders);
            renderOrders(allOrders);
        } catch (error) {
            console.error('Load error:', error);
            Swal.fire('Error', 'ไม่สามารถโหลดข้อมูลได้', 'error');
        }
    }

    function renderOrders(orders) {
        const tbody = document.getElementById('ordersTableBody');
        
        if (orders.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-400">ไม่พบรายการใบขอซื้อ</td></tr>`;
            return;
        }

        // Build HTML string first to avoid repeated DOM reflows (Optimization)
        let rowsHtml = '';
        orders.forEach((order, index) => {
            const dateStr = new Date(order.created_at).toLocaleDateString('th-TH');
            const total = (order.total_estimated_price || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            
            rowsHtml += `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="text-center text-gray-400">${index + 1}</td>
                    <td class="font-mono font-medium text-indigo-600">${order.order_no || '-'}</td>
                    <td class="text-gray-500 text-sm">${order.project_name || '-'}</td>
                    <td class="text-gray-500 text-sm">${dateStr}</td>
                    <td class="font-mono">${total}</td>
                    <td class="text-center">${getStatusBadge(order.status)}</td>
                    <td class="text-center">
                        <div class="join">
                            <a href="/api/orders/${order.id}/view/" class="btn btn-sm btn-ghost join-item" title="ดูรายละเอียด"><i class="fa-solid fa-eye"></i></a>
                            ${order.status === 'Draft' ? 
                                `<a href="/api/orders/${order.id}/edit/" class="btn btn-sm btn-ghost text-amber-500 join-item" title="แก้ไข"><i class="fa-solid fa-pen"></i></a>
                                 <button onclick="deleteOrder('${order.id}')" class="btn btn-sm btn-ghost text-red-500 join-item" title="ลบ"><i class="fa-solid fa-trash"></i></button>` 
                                : ''}
                            <a href="/api/orders/${order.id}/view/#imageGallery" class="btn btn-sm btn-ghost text-blue-600 join-item" title="ดูรูปภาพใบขอซื้อ"><i class="fa-solid fa-images"></i></a>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = rowsHtml;
    }

    function filterStatus(status) {
        document.querySelectorAll('.btn-active').forEach(b => b.classList.remove('btn-active', 'btn-primary'));
        event.target.classList.add('btn-active', 'btn-primary');

        if (status === 'all') {
            renderOrders(allOrders);
        } else {
            const filtered = allOrders.filter(o => o.status === status);
            renderOrders(filtered);
        }
    }

    function getStatusBadge(status) {
        const map = {
            'Draft': '<span class="badge badge-ghost badge-sm">ร่าง</span>',
            'Pending': '<span class="badge badge-warning text-white badge-sm">รออนุมัติ</span>',
            'Approved': '<span class="badge badge-success text-white badge-sm">อนุมัติแล้ว</span>',
            'Received': '<span class="badge badge-info text-white badge-sm">รับของแล้ว</span>',
            'Rejected': '<span class="badge badge-error text-white badge-sm">ไม่อนุมัติ</span>'
        };
        return map[status] || `<span class="badge badge-outline badge-sm">${status}</span>`;
    }

    async function deleteOrder(id) {
        const result = await Swal.fire({
            title: 'ยืนยันการลบ',
            text: "คุณต้องการลบรายการนี้ใช่หรือไม่?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'ลบรายการ',
            cancelButtonText: 'ยกเลิก'
        });

        if (result.isConfirmed) {
            try {
                const res = await fetchAPI(`/api/orders/${id}/`, { method: 'DELETE' });
                if (res.ok) {
                    Swal.fire('ลบสำเร็จ', '', 'success');
                    // Reload data
                    allOrders = allOrders.filter(o => o.id !== id);
                    renderOrders(allOrders);
                } else {
                    Swal.fire('ลบไม่สำเร็จ', 'เกิดข้อผิดพลาด', 'error');
                }
            } catch (error) {
                console.error(error);
            }
        }
    }
</script>
{% endblock %}
