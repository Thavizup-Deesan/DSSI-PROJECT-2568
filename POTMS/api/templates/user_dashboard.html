{% extends "base.html" %}
{% block title %}User Dashboard{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold">Dashboard</h1>
        <p class="text-sm text-base-content/50">โครงการและใบสั่งซื้อของฉัน</p>
    </div>
    <a href="/orders/create/" class="btn btn-primary btn-sm gap-2">
        <span class="material-icons-outlined text-base">add</span> สร้างใบสั่งซื้อ
    </a>
</div>

<!-- My Projects -->
<div class="card bg-base-200 border border-base-content/5 mb-6">
    <div class="card-body">
        <h2 class="card-title text-lg mb-4">โครงการที่เข้าร่วม</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="projectsGrid"></div>
    </div>
</div>

<!-- My Orders -->
<div class="card bg-base-200 border border-base-content/5">
    <div class="card-body">
        <div class="flex items-center justify-between mb-4">
            <h2 class="card-title text-lg">ใบสั่งซื้อของฉัน</h2>
            <a href="/orders/my/" class="btn btn-ghost btn-sm">ดูทั้งหมด →</a>
        </div>
        <div class="overflow-x-auto">
            <table class="table table-zebra">
                <thead><tr><th>เลขที่</th><th>โครงการ</th><th>จำนวน</th><th>สถานะ</th><th>วันที่</th></tr></thead>
                <tbody id="ordersTable"></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadDashboard() {
        const projects = await apiFetch('/api/projects/');
        const grid = document.getElementById('projectsGrid');
        if (projects.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full text-center py-10">
                    <span class="material-icons-outlined text-5xl text-base-content/20 mb-3">folder_off</span>
                    <p class="text-base-content/40">คุณยังไม่ได้เข้าร่วมโครงการใดๆ</p>
                    <p class="text-sm text-base-content/30 mt-1">ติดต่อเจ้าหน้าที่พัสดุเพื่อเพิ่มเข้าโครงการ</p>
                </div>
            `;
        } else {
            grid.innerHTML = projects.map(p => `
                <div class="card bg-base-300 border border-base-content/5 compact">
                    <div class="card-body">
                        <h3 class="card-title text-base">${p.project_name}</h3>
                        <div class="text-sm text-base-content/50">งบคงเหลือ: ฿${parseFloat(p.remaining_budget).toLocaleString()}</div>
                        <div class="card-actions justify-end mt-2">${getStatusBadge(p.status)}</div>
                    </div>
                </div>
            `).join('');
        }

        const orders = await apiFetch('/api/orders/');
        const tbody = document.getElementById('ordersTable');
        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-base-content/40">ยังไม่มีใบสั่งซื้อ</td></tr>';
            return;
        }
        tbody.innerHTML = orders.slice(0, 10).map(o => `
            <tr class="hover">
                <td><a href="/orders/detail/?id=${o.order_id}" class="link link-primary font-medium">${o.order_no}</a></td>
                <td>${o.project_name}</td>
                <td>฿${parseFloat(o.total_amount).toLocaleString()}</td>
                <td>${getStatusBadge(o.status)}</td>
                <td class="text-sm opacity-60">${new Date(o.created_at).toLocaleDateString('th-TH')}</td>
            </tr>
        `).join('');
    }
    loadDashboard();
</script>
{% endblock %}
