{% extends 'base.html' %}

{% block content %}
<div class="space-y-6">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs">
        <ul>
            <li><a href="/api/dashboard/">Dashboard</a></li>
            <li><a href="/api/orders/my/">รายการใบสั่งซื้อ</a></li>
            <li>บันทึกการรับของ</li>
        </ul>
    </div>

    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">บันทึกการรับของ</h1>
            <p class="text-gray-500">เลขที่: <span id="order-no" class="font-mono font-bold">{{ order_id }}</span></p>
        </div>
        <div class="flex gap-2">
            <button onclick="resetReceiving()" class="btn btn-sm btn-ghost text-error" title="ล้างข้อมูลการรับทั้งหมด">
                <i class="fa-solid fa-rotate-left mr-1"></i> รีเซ็ต
            </button>
            <span id="order-status" class="badge badge-lg">กำลังโหลด...</span>
        </div>
    </div>

    <!-- Order Summary -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <span class="text-sm text-gray-500">โครงการ</span>
                <p class="font-bold" id="project-name">-</p>
            </div>
            <div>
                <span class="text-sm text-gray-500">Vendor</span>
                <p class="font-medium" id="vendor-name">-</p>
            </div>
            <div>
                <span class="text-sm text-gray-500">จำนวนรายการ</span>
                <p class="font-medium" id="item-count">-</p>
            </div>
            <div>
                <span class="text-sm text-gray-500">ยอดรวม</span>
                <p class="font-bold text-primary" id="total-amount">-</p>
            </div>
        </div>
    </div>

    <!-- Items Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-4 border-b border-gray-50 bg-gray-50">
            <h2 class="font-bold text-lg text-gray-800">รายการพัสดุ</h2>
            <p class="text-sm text-gray-500">ติ๊กเลือกรายการที่ได้รับและกรอกจำนวน (หลังจากคณะกรรมการตรวจรับเสร็จ)</p>
        </div>
        
        <div class="overflow-x-auto">
            <table class="table w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="w-12">
                            <input type="checkbox" id="select-all" class="checkbox checkbox-primary checkbox-sm" />
                        </th>
                        <th>#</th>
                        <th>รายการ</th>
                        <th class="text-center">ทั้งหมด</th>
                        <th class="text-center">ได้รับก่อนหน้า</th>
                        <th class="text-center">รับรอบนี้</th>
                        <th class="text-center">คงเหลือ</th>
                    </tr>
                </thead>
                <tbody id="items-table-body">
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-400">
                            <span class="loading loading-spinner loading-md"></span> กำลังโหลด...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-between items-center">
        <a href="/api/orders/{{ order_id }}/view/" class="btn btn-ghost">
            <i class="fa-solid fa-arrow-left mr-2"></i> กลับ
        </a>
        <div class="flex gap-3">
            <button id="btn-save" onclick="saveReceiving(false)" class="btn btn-outline btn-primary">
                <i class="fa-solid fa-save mr-2"></i> บันทึก (ยังไม่ครบ)
            </button>
            <button id="btn-complete" onclick="saveReceiving(true)" class="btn btn-success text-white">
                <i class="fa-solid fa-check-circle mr-2"></i> ยืนยันรับครบ
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const orderId = "{{ order_id }}";
    let orderData = null;
    let itemsData = [];

    document.addEventListener('DOMContentLoaded', async () => {
        await loadOrderItems();
        setupSelectAll();
    });

    async function loadOrderItems() {
        try {
            const res = await fetchAPI(`/api/api/orders/${orderId}/receive/`);
            if (!res.ok) throw new Error('Failed to load');
            
            const data = await res.json();
            orderData = data.order;
            itemsData = data.items;
            
            // Update header
            document.getElementById('order-no').textContent = orderData.order_no || orderId;
            document.getElementById('project-name').textContent = orderData.project_name || '-';
            document.getElementById('vendor-name').textContent = orderData.vendor_name || '-';
            document.getElementById('item-count').textContent = `${itemsData.length} รายการ`;
            document.getElementById('total-amount').textContent = 
                (orderData.total_estimated_price || 0).toLocaleString() + ' บาท';
            
            const statusBadge = document.getElementById('order-status');
            statusBadge.textContent = data.status;
            statusBadge.className = `badge badge-lg ${getStatusBadge(data.status)}`;
            
            renderItemsTable();
        } catch (err) {
            console.error(err);
            document.getElementById('items-table-body').innerHTML = `
                <tr><td colspan="7" class="text-center py-8 text-red-500">โหลดข้อมูลไม่สำเร็จ</td></tr>
            `;
        }
    }

    function renderItemsTable() {
        const tbody = document.getElementById('items-table-body');
        
        if (itemsData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-400">ไม่มีรายการ</td></tr>`;
            return;
        }
        
        tbody.innerHTML = itemsData.map((item, idx) => {
            const total = parseFloat(item.quantity_total || item.quantity || 0);
            const received = parseFloat(item.quantity_received || 0);
            const pending = total - received;
            const isComplete = pending <= 0;
            
            return `
                <tr class="hover:bg-gray-50">
                    <td>
                        <input type="checkbox" class="checkbox checkbox-primary checkbox-sm item-cb" 
                               data-id="${item.id}" ${isComplete ? 'disabled checked' : ''} />
                    </td>
                    <td>${idx + 1}</td>
                    <td>
                        <div class="font-bold">${item.item_name || '-'}</div>
                        <div class="text-xs text-gray-500">${item.unit || ''}</div>
                    </td>
                    <td class="text-center font-mono font-bold">${total}</td>
                    <td class="text-center">
                        <span class="badge badge-ghost">${received}</span>
                    </td>
                    <td class="text-center">
                        <input type="number" class="input input-bordered input-sm w-20 text-center qty-input" 
                               data-id="${item.id}" min="0" max="${pending}" 
                               value="${isComplete ? 0 : pending}" 
                               ${isComplete ? 'disabled' : ''} />
                    </td>
                    <td class="text-center">
                        <span class="badge ${pending > 0 ? 'badge-warning' : 'badge-success'}">${pending}</span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function setupSelectAll() {
        document.getElementById('select-all').addEventListener('change', (e) => {
            document.querySelectorAll('.item-cb:not(:disabled)').forEach(cb => {
                cb.checked = e.target.checked;
            });
        });
    }

    async function saveReceiving(isFinal) {
        const selectedItems = [];
        document.querySelectorAll('.item-cb:checked:not(:disabled)').forEach(cb => {
            const id = cb.dataset.id;
            const qty = parseFloat(document.querySelector(`.qty-input[data-id="${id}"]`)?.value || 0);
            if (qty > 0) {
                selectedItems.push({ item_id: id, quantity_received: qty });
            }
        });

        if (selectedItems.length === 0 && !isFinal) {
            Swal.fire('แจ้งเตือน', 'กรุณาเลือกรายการที่ได้รับ', 'warning');
            return;
        }

        if (isFinal) {
            const result = await Swal.fire({
                title: 'ยืนยันรับครบ?',
                text: 'เมื่อยืนยันแล้วจะไม่สามารถแก้ไขได้',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4f46e5',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก'
            });
            if (!result.isConfirmed) return;
        }

        try {
            Swal.showLoading();
            
            const res = await fetchAPI(`/api/api/orders/${orderId}/receive/`, {
                method: 'POST',
                body: JSON.stringify({ items: selectedItems, is_final: isFinal })
            });

            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกสำเร็จ',
                    text: isFinal ? 'รับของครบแล้ว' : 'บันทึกเรียบร้อย',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    if (isFinal) {
                        window.location.href = '/api/orders/my/';
                    } else {
                        loadOrderItems();
                    }
                });
            } else {
                throw new Error('Failed');
            }
        } catch (err) {
            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกได้ ' + err.message, 'error');
        }
    }

    async function resetReceiving() {
        const result = await Swal.fire({
            title: 'รีเซ็ตข้อมูลการรับ?',
            text: 'ยอดที่รับทั้งหมดจะถูกล้างเป็น 0 และสถานะจะกลับไปเป็น "รอรับของ"',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'รีเซ็ต',
            cancelButtonText: 'ยกเลิก'
        });

        if (result.isConfirmed) {
            try {
                const res = await fetchAPI(`/api/api/orders/${orderId}/receive/`, {
                    method: 'DELETE'
                });
                if (res.ok) {
                    Swal.fire('สำเร็จ', 'รีเซ็ตข้อมูลเรียบร้อย', 'success').then(() => location.reload());
                } else {
                    throw new Error('Failed to reset');
                }
            } catch (err) {
                Swal.fire('Error', 'ไม่สามารถรีเซ็ตได้', 'error');
            }
        }
    }

    function getStatusBadge(status) {
        const badges = {
            'รอรับของ': 'badge-warning',
            'รับบางส่วน': 'badge-info',
            'รับครบ': 'badge-success'
        };
        return badges[status] || 'badge-outline';
    }
</script>
{% endblock %}
