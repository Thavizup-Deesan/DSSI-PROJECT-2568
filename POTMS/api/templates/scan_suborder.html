<!DOCTYPE html>
<html lang="th">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | POTMS</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap"
                rel="stylesheet">
        <style>
                * {
                        font-family: 'Prompt', sans-serif;
                }
        </style>
</head>

<body class="bg-gradient-to-b from-cyan-500 to-blue-600 min-h-screen">
        <!-- Header -->
        <header class="bg-white/90 backdrop-blur shadow-lg sticky top-0 z-50">
                <div class="container mx-auto px-4 py-3 flex items-center justify-center">
                        <h1 class="text-lg font-bold text-cyan-600">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
                </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6">
                <!-- Loading State -->
                <div id="loadingState" class="flex flex-col items-center justify-center py-20">
                        <div
                                class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-4">
                        </div>
                        <p class="text-white text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>

                <!-- Error State -->
                <div id="errorState" class="hidden">
                        <div class="bg-white rounded-2xl shadow-xl p-6 text-center">
                                <div class="text-6xl mb-4"></div>
                                <h2 class="text-xl font-bold text-red-600 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                                <p id="errorMessage" class="text-gray-600 mb-4">‡πÑ‡∏°‡πà‡∏û‡∏ö Sub-order ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                                <a href="/"
                                        class="inline-block px-6 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition">
                                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                                </a>
                        </div>
                </div>

                <!-- Success Content -->
                <div id="contentState" class="hidden space-y-4">
                        <!-- Status Card -->
                        <div id="statusCard" class="bg-white rounded-2xl shadow-xl p-5">
                                <div class="flex items-center justify-between mb-3">
                                        <span class="text-gray-500 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                                        <span id="statusBadge"
                                                class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700">
                                                ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                                        </span>
                                </div>
                                <h2 id="suborderNo" class="text-xl font-bold text-gray-800 mb-1">SUB-PO-001</h2>
                                <p id="inspectedDate" class="text-gray-500 text-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠: -</p>
                        </div>

                        <!-- Order Info Card -->
                        <div class="bg-white rounded-2xl shadow-xl p-5">
                                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">
                                        üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                                </h3>
                                <div class="space-y-3">
                                        <div class="flex justify-between">
                                                <span class="text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà Order</span>
                                                <span id="orderNo" class="font-medium text-gray-800">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                                <span class="text-gray-500">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</span>
                                                <span id="projectName"
                                                        class="font-medium text-gray-800 text-right max-w-[60%]">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                                <span class="text-gray-500">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö</span>
                                                <span id="inspectorName" class="font-medium text-gray-800">-</span>
                                        </div>
                                </div>
                        </div>

                        <!-- Cost Card -->
                        <div class="bg-white rounded-2xl shadow-xl p-5">
                                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">
                                        ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
                                </h3>
                                <div class="space-y-3">
                                        <div class="flex justify-between">
                                                <span class="text-gray-500">‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£</span>
                                                <span id="estimatedCost" class="font-medium text-gray-600">‡∏ø0</span>
                                        </div>
                                        <div class="flex justify-between">
                                                <span class="text-gray-500">‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</span>
                                                <span id="actualCost" class="font-bold text-cyan-600 text-lg">‡∏ø0</span>
                                        </div>
                                        <div id="costDifferenceRow" class="flex justify-between hidden">
                                                <span class="text-gray-500">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</span>
                                                <span id="costDifference" class="font-medium">‡∏ø0</span>
                                        </div>
                                </div>
                        </div>

                        <!-- Items Card -->
                        <div class="bg-white rounded-2xl shadow-xl p-5">
                                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">
                                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (<span id="itemsCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                                </h3>
                                <div id="itemsList" class="space-y-3">
                                        <!-- Items will be populated here -->
                                </div>
                        </div>

                        <!-- Notes Card (if exists) -->
                        <div id="notesCard" class="bg-white rounded-2xl shadow-xl p-5 hidden">
                                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">
                                        ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                                </h3>
                                <p id="inspectionNotes" class="text-gray-700">-</p>
                        </div>

                        <!-- Footer -->
                        <div class="text-center py-4">
                                <p class="text-white/80 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (POTMS)</p>
                                <p class="text-white/60 text-xs mt-1">Procurement Order Tracking Management System</p>
                        </div>
                </div>
        </main>

        <script>
                // Get suborder ID from URL
                const pathParts = window.location.pathname.split('/');
                const suborderId = pathParts[pathParts.length - 2] || pathParts[pathParts.length - 1];

                // Status map
                const statusMap = {
                        'WaitingInspection': { text: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö', class: 'bg-yellow-100 text-yellow-700' },
                        'Inspected': { text: '‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß', class: 'bg-green-100 text-green-700' },
                        'Received': { text: '‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', class: 'bg-blue-100 text-blue-700' },
                        'Closed': { text: '‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß', class: 'bg-gray-200 text-gray-600' }
                };

                // Load suborder data
                async function loadSuborderData() {
                        try {
                                const response = await fetch(`/api/scan/${suborderId}/data/`);

                                if (!response.ok) {
                                        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Sub-order ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
                                }

                                const data = await response.json();
                                displayData(data);

                        } catch (error) {
                                showError(error.message);
                        }
                }

                // Display data
                function displayData(data) {
                        document.getElementById('loadingState').classList.add('hidden');
                        document.getElementById('contentState').classList.remove('hidden');

                        // Status
                        const status = statusMap[data.status] || { text: data.status, class: 'bg-gray-100 text-gray-700' };
                        const statusBadge = document.getElementById('statusBadge');
                        statusBadge.textContent = status.text;
                        statusBadge.className = `px-3 py-1 rounded-full text-sm font-medium ${status.class}`;

                        // Basic info
                        document.getElementById('suborderNo').textContent = data.suborder_no || '-';
                        document.getElementById('inspectedDate').textContent =
                                data.inspected_at ? `‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDate(data.inspected_at)}` : '';
                        document.getElementById('orderNo').textContent = data.order_no || '-';
                        document.getElementById('projectName').textContent = data.project_name || '-';
                        document.getElementById('inspectorName').textContent = data.inspector_name || '-';

                        // Costs
                        const estimated = parseFloat(data.total_amount || 0);
                        const actual = parseFloat(data.actual_cost || 0);
                        const difference = actual - estimated;

                        document.getElementById('estimatedCost').textContent = `‡∏ø${estimated.toLocaleString()}`;
                        document.getElementById('actualCost').textContent = `‡∏ø${actual.toLocaleString()}`;

                        if (difference !== 0) {
                                document.getElementById('costDifferenceRow').classList.remove('hidden');
                                const diffEl = document.getElementById('costDifference');
                                diffEl.textContent = `${difference > 0 ? '+' : ''}‡∏ø${difference.toLocaleString()}`;
                                diffEl.className = `font-medium ${difference > 0 ? 'text-red-600' : 'text-green-600'}`;
                        }

                        // Items
                        const items = data.items || [];
                        document.getElementById('itemsCount').textContent = items.length;

                        const itemsContainer = document.getElementById('itemsList');
                        itemsContainer.innerHTML = items.map((item, index) => `
                                <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                                        <span class="flex-shrink-0 w-6 h-6 bg-cyan-500 text-white rounded-full flex items-center justify-center text-xs font-bold">
                                                ${index + 1}
                                        </span>
                                        <div class="flex-1 min-w-0">
                                                <p class="font-medium text-gray-800 truncate">${item.item_name || item.name || '-'}</p>
                                                <p class="text-sm text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.quantity || item.quantity_requested || 0} ${item.unit || ''}</p>
                                        </div>
                                        <div class="text-right">
                                                <p class="font-medium text-gray-800">‡∏ø${parseFloat(item.unit_price || item.estimated_unit_price || 0).toLocaleString()}</p>
                                                <p class="text-xs text-gray-500">‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
                                        </div>
                                </div>
                        `).join('');

                        // Notes
                        if (data.inspection_notes) {
                                document.getElementById('notesCard').classList.remove('hidden');
                                document.getElementById('inspectionNotes').textContent = data.inspection_notes;
                        }
                }

                // Show error
                function showError(message) {
                        document.getElementById('loadingState').classList.add('hidden');
                        document.getElementById('errorState').classList.remove('hidden');
                        document.getElementById('errorMessage').textContent = message;
                }

                // Format date
                function formatDate(dateString) {
                        try {
                                const date = new Date(dateString);
                                return date.toLocaleDateString('th-TH', {
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                });
                        } catch {
                                return dateString;
                        }
                }

                // Initialize
                loadSuborderData();
        </script>
</body>

</html>