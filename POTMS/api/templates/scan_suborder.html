<!DOCTYPE html>
<html lang="th">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | POTMS</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap"
                rel="stylesheet">
        <style>
                * {
                        font-family: 'Prompt', sans-serif;
                }
        </style>
</head>

<body class="bg-gradient-to-b from-cyan-500 to-blue-600 min-h-screen">
        <!-- Header -->
        <header class="bg-white/90 backdrop-blur shadow-lg sticky top-0 z-50">
                <div class="container mx-auto px-4 py-3 flex items-center justify-center">
                        <h1 class="text-lg font-bold text-cyan-600">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
                </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6">
                <!-- Loading State -->
                <div id="loadingState" class="flex flex-col items-center justify-center py-20">
                        <div
                                class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-4">
                        </div>
                        <p class="text-white text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>

                <!-- Error State -->
                <div id="errorState" class="hidden">
                        <div class="bg-white rounded-2xl shadow-xl p-6 text-center">
                                <div class="text-6xl mb-4"></div>
                                <h2 class="text-xl font-bold text-red-600 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                                <p id="errorMessage" class="text-gray-600 mb-4">‡πÑ‡∏°‡πà‡∏û‡∏ö Sub-order ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                                <a href="/"
                                        class="inline-block px-6 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition">
                                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                                </a>
                        </div>
                </div>

                <!-- Success Content -->
                <div id="contentState" class="hidden space-y-4">
                        <!-- Status Card -->
                        <div id="statusCard" class="bg-white rounded-2xl shadow-xl p-5">
                                <div class="flex items-center justify-between mb-3">
                                        <span class="text-gray-500 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                                        <span id="statusBadge"
                                                class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700">
                                                ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                                        </span>
                                </div>
                                <h2 id="suborderNo" class="text-xl font-bold text-gray-800 mb-1">SUB-PO-001</h2>
                                <p id="inspectedDate" class="text-gray-500 text-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠: -</p>
                        </div>

                        <!-- Order Info Card -->
                        <div class="bg-white rounded-2xl shadow-xl p-5">
                                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">
                                        üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                                </h3>
                                <div class="space-y-3">
                                        <div class="flex justify-between">
                                                <span class="text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà Order</span>
                                                <span id="orderNo" class="font-medium text-gray-800">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                                <span class="text-gray-500">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</span>
                                                <span id="projectName"
                                                        class="font-medium text-gray-800 text-right max-w-[60%]">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                                <span class="text-gray-500">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö</span>
                                                <span id="inspectorName" class="font-medium text-gray-800">-</span>
                                        </div>
                                </div>
                        </div>

                        <!-- Cost Card -->
                        <div class="bg-white rounded-2xl shadow-xl p-5">
                                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">
                                        ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
                                </h3>
                                <div class="space-y-3">
                                        <div class="flex justify-between">
                                                <span class="text-gray-500">‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£</span>
                                                <span id="estimatedCost" class="font-medium text-gray-600">‡∏ø0</span>
                                        </div>
                                        <div class="flex justify-between">
                                                <span class="text-gray-500">‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</span>
                                                <span id="actualCost" class="font-bold text-cyan-600 text-lg">‡∏ø0</span>
                                        </div>
                                        <div id="costDifferenceRow" class="flex justify-between hidden">
                                                <span class="text-gray-500">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</span>
                                                <span id="costDifference" class="font-medium">‡∏ø0</span>
                                        </div>
                                </div>
                        </div>

                <!-- Inspection Form (Visible only when WaitingInspection) -->
                <div id="inspectionForm" class="hidden space-y-4">
                        <div class="bg-white rounded-2xl shadow-xl p-5">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö</h3>
                                
                                <!-- Inspector Name -->
                                <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö</label>
                                        <input type="text" id="inspectorNameInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö">
                                </div>

                                <!-- Items Table for Input -->
                                <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</label>
                                        <div id="inspectionItemsList" class="space-y-3">
                                                <!-- Items will be injected here -->
                                        </div>
                                </div>

                                <!-- Actual Cost -->
                                <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</label>
                                        <input type="number" id="actualCostInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="0.00">
                                </div>

                                <!-- Notes -->
                                <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                                        <textarea id="inspectionNotesInput" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                                </div>

                                <button onclick="submitInspection()" class="w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-cyan-700 transition shadow-lg">
                                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö
                                </button>
                        </div>
                </div>
        </main>

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
                // Get suborder ID from URL
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                const suborderId = pathParts[pathParts.indexOf('scan') + 1];

                // Status map
                const statusMap = {
                        'WaitingInspection': { text: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö', class: 'bg-yellow-100 text-yellow-700' },
                        'Inspected': { text: '‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß', class: 'bg-green-100 text-green-700' },
                        'Received': { text: '‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', class: 'bg-blue-100 text-blue-700' },
                        'Closed': { text: '‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß', class: 'bg-gray-200 text-gray-600' }
                };

                let currentSuborderData = null;

                // Load suborder data
                async function loadSuborderData() {
                        try {
                                const response = await fetch(`/api/scan/${suborderId}/data/`);

                                if (!response.ok) {
                                        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Sub-order ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
                                }

                                const data = await response.json();
                                currentSuborderData = data;
                                displayData(data);

                        } catch (error) {
                                showError(error.message);
                        }
                }

                // Display data
                function displayData(data) {
                        document.getElementById('loadingState').classList.add('hidden');
                        
                        if (data.status === 'WaitingInspection') {
                                document.getElementById('contentState').classList.add('hidden'); // Hide partial read-only view
                                document.getElementById('inspectionForm').classList.remove('hidden');
                                renderInspectionForm(data);
                        } else {
                                document.getElementById('contentState').classList.remove('hidden');
                                document.getElementById('inspectionForm').classList.add('hidden');
                                renderReadOnlyView(data);
                        }
                }

                function renderReadOnlyView(data) {
                         // Status
                        const status = statusMap[data.status] || { text: data.status, class: 'bg-gray-100 text-gray-700' };
                        const statusBadge = document.getElementById('statusBadge');
                        statusBadge.textContent = status.text;
                        statusBadge.className = `px-3 py-1 rounded-full text-sm font-medium ${status.class}`;

                        // Basic info
                        document.getElementById('suborderNo').textContent = data.suborder_no || '-';
                        document.getElementById('inspectedDate').textContent =
                                data.received_date ? `‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDate(data.received_date)}` : '';
                        document.getElementById('orderNo').textContent = data.order_no || '-';
                        document.getElementById('projectName').textContent = data.project_name || '-';
                        document.getElementById('inspectorName').textContent = data.inspector_name || '-';

                        // Costs
                        const estimated = parseFloat(data.total_amount || 0); // Note: API needs to ensure these fields exist
                        const actual = parseFloat(data.actual_cost || 0);
                        const difference = actual - estimated;

                        document.getElementById('estimatedCost').textContent = `‡∏ø${estimated.toLocaleString()}`;
                        document.getElementById('actualCost').textContent = `‡∏ø${actual.toLocaleString()}`;

                        // Items
                        const items = data.items || [];
                        document.getElementById('itemsCount').textContent = items.length;

                        const itemsContainer = document.getElementById('itemsList');
                        itemsContainer.innerHTML = items.map((item, index) => `
                                <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                                        <span class="flex-shrink-0 w-6 h-6 bg-cyan-500 text-white rounded-full flex items-center justify-center text-xs font-bold">
                                                ${index + 1}
                                        </span>
                                        <div class="flex-1 min-w-0">
                                                <p class="font-medium text-gray-800 truncate">${item.item_name || item.name || '-'}</p>
                                                <p class="text-sm text-gray-500">
                                                    ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ${item.qty_received_so_far} / ${item.quantity_requested} ${item.unit}
                                                </p>
                                        </div>
                                </div>
                        `).join('');
                }

                function renderInspectionForm(data) {
                    // Populate Inspection List
                    const list = document.getElementById('inspectionItemsList');
                    const items = data.items || [];
                    
                    list.innerHTML = items.map((item, index) => {
                        const remaining = item.qty_remaining;
                        const isFullyReceived = remaining <= 0;
                        
                        return `
                        <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <p class="font-medium text-gray-900">${item.item_name}</p>
                                    <p class="text-xs text-gray-500">
                                        ‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠: ${item.quantity_requested} | ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ${item.qty_received_so_far} | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span class="text-orange-600 font-bold">${remaining}</span>
                                    </p>
                                </div>
                                <input type="checkbox" class="item-checkbox w-5 h-5 text-cyan-600 rounded" 
                                        data-index="${index}" 
                                        ${isFullyReceived ? 'disabled' : 'checked'} 
                                        onchange="toggleItemInput(${index})">
                            </div>
                            <div id="input-container-${index}" class="${isFullyReceived ? 'hidden' : ''}">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-600">‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ:</span>
                                    <input type="number" 
                                        id="qty-input-${index}"
                                        class="item-qty-input w-24 px-2 py-1 border border-gray-300 rounded text-center focus:ring-cyan-500 focus:border-cyan-500" 
                                        value="${remaining}" 
                                        max="${remaining}" 
                                        min="0">
                                    <span class="text-sm text-gray-500">${item.unit}</span>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');

                    // Pre-fill total estimated cost as default actual cost
                    // We need to sum up estimated cost of remaining items? Or just total?
                    // Usually actual cost is per invoice. Let's leave it 0 or user fills it.
                }

                function toggleItemInput(index) {
                    const checkbox = document.querySelector(`.item-checkbox[data-index="${index}"]`);
                    const container = document.getElementById(`input-container-${index}`);
                    if (checkbox.checked) {
                        container.classList.remove('hidden');
                    } else {
                        container.classList.add('hidden');
                    }
                }

                async function submitInspection() {
                    const inspectorName = document.getElementById('inspectorNameInput').value.trim();
                    const actualCost = parseFloat(document.getElementById('actualCostInput').value) || 0;
                    const notes = document.getElementById('inspectionNotesInput').value.trim();

                    if (!inspectorName) {
                        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö', 'error');
                        return;
                    }
                    
                    if (actualCost <= 0) {
                        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á', 'error');
                        return;
                    }

                    // Collect items
                    const itemsToReceive = [];
                    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
                    
                    checkboxes.forEach(cb => {
                        const index = cb.dataset.index;
                        const item = currentSuborderData.items[index];
                        const qtyInput = document.getElementById(`qty-input-${index}`);
                        const qty = parseFloat(qtyInput.value) || 0;
                        
                        if (qty > 0) {
                            itemsToReceive.push({
                                item_id: item.item_id,
                                qty_received: qty
                            });
                        }
                    });

                    if (itemsToReceive.length === 0) {
                        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'warning');
                        return;
                    }

                    try {
                        Swal.fire({
                            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                            allowOutsideClick: false,
                            didOpen: () => Swal.showLoading()
                        });

                        const response = await fetch(`/api/suborders/${suborderId}/inspection/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                // Note: Depending on security, we might need auth or simpler public token check
                            },
                            body: JSON.stringify({
                                inspector_name: inspectorName,
                                actual_cost: actualCost,
                                notes: notes,
                                received_items: itemsToReceive
                            })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => {
                                window.location.reload();
                            });
                        } else {
                            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'error');
                        }
                    } catch (error) {
                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
                    }
                }

                // Show error
                function showError(message) {
                        document.getElementById('loadingState').classList.add('hidden');
                        document.getElementById('errorState').classList.remove('hidden');
                        document.getElementById('errorMessage').textContent = message;
                }

                // Format date
                function formatDate(dateString) {
                        try {
                                const date = new Date(dateString);
                                return date.toLocaleDateString('th-TH', {
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                });
                        } catch {
                                return dateString;
                        }
                }

                // Initialize
                loadSuborderData();
        </script>
</body>
</html>