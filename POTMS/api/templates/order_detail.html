{% extends 'base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header / Actions -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100 gap-4">
        <div>
            <a href="/api/orders/my/" class="text-gray-500 hover:text-indigo-600 text-sm"><i class="fa-solid fa-arrow-left mr-1"></i> กลับ</a>
            <h1 class="text-xl font-bold text-gray-800 mt-1">รายละเอียดใบขอซื้อ <span id="orderNo" class="text-indigo-600 font-mono text-lg ml-2">...</span></h1>
        </div>
        <div class="flex flex-wrap gap-2 w-full md:w-auto mt-2 md:mt-0" id="actionButtons">
            <!-- Dynamic Actions -->
        </div>
    </div>

    <!-- Status Timeline -->
    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
        <ul class="steps w-full min-w-[500px] md:min-w-0" id="statusTimeline">
            <li class="step">ร่าง (Draft)</li>
            <li class="step">รอ</li>
            <li class="step">รอรับของ</li>
            <li class="step">รับบางส่วน</li>
            <li class="step">รับครบ</li>
        </ul>
    </div>

    <!-- Detail Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-6 border-b border-gray-100 bg-gray-50/50">
            <div class="text-right">
                <p class="text-sm text-gray-500">วันที่สร้าง</p>
                <p class="font-medium text-gray-800" id="requiredDate">...</p>
            </div>
        </div>

        <!-- Items Table -->
        <div class="p-4 md:p-6">
            <h3 class="font-bold text-gray-700 mb-4">รายการสินค้า</h3>
            <div class="overflow-x-auto">
                <table class="table w-full border border-gray-100 rounded-lg whitespace-nowrap">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="w-12 text-center">#</th>
                        <th>รายการ</th>
                        <th class="text-right">จำนวน</th>
                        <th class="text-center">หน่วย</th>
                        <th class="text-right">ราคา/หน่วย</th>
                        <th class="text-right">รวมเงิน</th>
                    </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
                <tfoot>
                    <tr class="bg-indigo-50 font-bold text-lg text-indigo-900">
                        <td colspan="5" class="text-right">ยอดรวมสุทธิ</td>
                        <td class="text-right" id="grandTotal">0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Image Upload Section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-700"><i class="fa-solid fa-images mr-2"></i>รูปภาพประกอบ</h3>
                <label class="btn btn-primary btn-sm text-white cursor-pointer">
                    <i class="fa-solid fa-upload mr-1"></i> อัพโหลดรูป
                    <input type="file" accept="image/*" id="imageUpload" class="hidden" onchange="uploadImage(this)">
                </label>
            </div>
            
            <!-- Image Gallery -->
            <div id="imageGallery" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center text-gray-400 col-span-full py-8" id="noImagesMsg">
                    <i class="fa-solid fa-image text-4xl mb-2"></i>
                    <p>ยังไม่มีรูปภาพ</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Get Order ID from URL path (Django handles this, but since we are SPA-ish inside Django templates)
    const pathParts = window.location.pathname.split('/');
    const orderId = pathParts[3]; // /api/orders/<id>/view/

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetchAPI(`/api/orders/${orderId}/`);
            if (!response.ok) throw new Error('Failed to load order');
            
            const order = await response.json();
            renderOrder(order);
        } catch (error) {
            Swal.fire('Error', 'ไม่พบข้อมูลใบขอซื้อ', 'error').then(() => window.location.href = '/api/orders/my/');
        }
    });

    function renderOrder(order) {
        document.getElementById('orderNo').textContent = order.order_no || order.id;
        document.getElementById('requiredDate').textContent = new Date(order.created_at).toLocaleDateString('th-TH');

        // Items
        const tbody = document.getElementById('itemsBody');
        let total = 0;
        
        order.items.forEach((item, idx) => {
            const qty = parseFloat(item.quantity || item.quantity_requested || 0);
            const price = parseFloat(item.unit_price || item.estimated_unit_price || 0);
            const subtotal = qty * price;
            total += subtotal;

            tbody.innerHTML += `
                <tr>
                    <td class="text-center text-gray-400">${idx + 1}</td>
                    <td>${item.item_name || item.name}</td>
                    <td class="text-right font-mono">${qty}</td>
                    <td class="text-center text-sm text-gray-500">${item.unit}</td>
                    <td class="text-right font-mono text-gray-500">${price.toLocaleString()}</td>
                    <td class="text-right font-mono font-bold text-gray-700">${subtotal.toLocaleString()}</td>
                </tr>
            `;
        });
        document.getElementById('grandTotal').textContent = total.toLocaleString('th-TH', {minimumFractionDigits: 2});

        // Update Timeline Steps based on status
        updateTimeline(order.status);

        // Update Actions
        updateActions(order);
    }

    function updateTimeline(status) {
        const steps = document.querySelectorAll('.step');
        let activeIdx = -1;
        
        // New workflow: Draft → รอ → รอรับของ → รับบางส่วน → รับครบ
        if (status === 'Draft') activeIdx = 0;
        else if (status === 'รอ' || status === 'Pending') activeIdx = 1;
        else if (status === 'รอรับของ' || status === 'Approved') activeIdx = 2;
        else if (status === 'รับบางส่วน') activeIdx = 3;
        else if (status === 'รับครบ' || status === 'Received') activeIdx = 4;

        steps.forEach((step, idx) => {
            if (idx <= activeIdx) step.classList.add('step-primary');
        });
    }

    function updateActions(order) {
        const container = document.getElementById('actionButtons');
        container.innerHTML = ''; // Clear first
        
        // Image Buttons (Always visible - replaced print buttons)
        container.innerHTML += `
            <button onclick="scrollToImages()" class="btn btn-primary btn-sm text-white">
                <i class="fa-solid fa-images mr-1"></i> ดูรูปภาพ
            </button>
        `;

        // Edit/Submit (If Draft)
        if (order.status === 'Draft') {
            container.innerHTML += `
                <a href="/api/orders/${order.id}/edit/" class="btn btn-warning btn-outline btn-sm">แก้ไข</a>
                <button onclick="submitDraft('${order.id}')" class="btn btn-primary btn-sm text-white">ส่งใบขอซื้อ</button>
            `;
        }
        
        // Confirm Boss Approved (If รอ/Pending) - ผู้ขอซื้อ confirms boss signed offline
        if (order.status === 'รอ' || order.status === 'Pending') {
            container.innerHTML += `
                <button onclick="confirmBossApproved('${order.id}')" class="btn btn-success btn-sm text-white">
                    <i class="fa-solid fa-check mr-1"></i> หัวหน้าเซ็นแล้ว
                </button>
            `;
        }
        
        // QR Code & Record Receiving (If รอรับของ/รับบางส่วน)
        if (['รอรับของ', 'รับบางส่วน', 'Approved'].includes(order.status)) {
            container.innerHTML += `
                <a href="/api/orders/${order.id}/qr/" class="btn btn-outline btn-sm">
                    <i class="fa-solid fa-qrcode mr-1"></i> QR ตรวจรับ
                </a>
                <a href="/api/orders/${order.id}/receive/" class="btn btn-info btn-sm text-white">
                    <i class="fa-solid fa-box-open mr-1"></i> บันทึกรับของ
                </a>
            `;
        }
    }

    async function submitDraft(id) {
        const result = await Swal.fire({
            title: 'ยืนยันการส่ง',
            text: 'คุณต้องการส่งใบขอซื้อนี้เพื่อขออนุมัติหรือไม่?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#4f46e5',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'ยืนยันส่ง',
            cancelButtonText: 'ยกเลิก'
        });

        if (result.isConfirmed) {
            try {
                const res = await fetchAPI(`/api/orders/${id}/submit/`, { method: 'POST' });
                if (res.ok) {
                    Swal.fire('สำเร็จ', 'ส่งใบขอซื้อเรียบร้อย', 'success').then(() => location.reload());
                } else {
                    const data = await res.json();
                    Swal.fire('เกิดข้อผิดพลาด', data.error, 'error');
                }
            } catch (err) {
                console.error(err);
            }
        }
    }

    async function confirmBossApproved(id) {
        const result = await Swal.fire({
            title: 'ยืนยันหัวหน้าเซ็นแล้ว',
            text: 'หัวหน้าภาควิชาได้ลงนามในเอกสารแล้วใช่หรือไม่?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#4f46e5',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'ยืนยัน',
            cancelButtonText: 'ยกเลิก'
        });

        if (result.isConfirmed) {
            try {
                const res = await fetchAPI(`/api/api/orders/${id}/update-status/`, {
                    method: 'POST',
                    body: JSON.stringify({ status: 'รอรับของ' })
                });
                if (res.ok) {
                    Swal.fire('สำเร็จ', 'เปลี่ยนสถานะเรียบร้อย', 'success').then(() => location.reload());
                } else {
                    const data = await res.json();
                    Swal.fire('เกิดข้อผิดพลาด', data.error || 'ไม่สามารถเปลี่ยนสถานะได้', 'error');
                }
            } catch (err) {
                console.error(err);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้', 'error');
            }
        }
    }

    // ===== Image Upload Functions =====
    async function loadImages() {
        try {
            const res = await fetchAPI(`/api/orders/${orderId}/images/`);
            if (res.ok) {
                const data = await res.json();
                renderImages(data.images || []);
            }
        } catch (err) {
            console.error('Failed to load images:', err);
        }
    }

    function renderImages(images) {
        const gallery = document.getElementById('imageGallery');
        const noImagesMsg = document.getElementById('noImagesMsg');
        
        if (images.length === 0) {
            noImagesMsg.style.display = 'block';
            return;
        }
        
        noImagesMsg.style.display = 'none';
        
        images.forEach(img => {
            const div = document.createElement('div');
            div.className = 'relative group';
            div.innerHTML = `
                <img src="${img.url}" class="w-full h-32 object-cover rounded-lg border border-gray-200 cursor-pointer hover:opacity-90" 
                     onclick="viewImage('${img.url}')" 
                     alt="${img.description || 'รูปภาพ'}">
                <button onclick="deleteImage(${img.id})" 
                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="fa-solid fa-times text-xs"></i>
                </button>
            `;
            gallery.appendChild(div);
        });
    }

    async function uploadImage(input) {
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('image', file);

        try {
            Swal.fire({ title: 'กำลังอัพโหลด...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const res = await fetch(`/api/orders/${orderId}/images/`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                body: formData
            });

            if (res.ok) {
                Swal.fire('สำเร็จ', 'อัพโหลดรูปภาพเรียบร้อย', 'success').then(() => location.reload());
            } else {
                const data = await res.json();
                Swal.fire('เกิดข้อผิดพลาด', data.error || 'ไม่สามารถอัพโหลดได้', 'error');
            }
        } catch (err) {
            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้', 'error');
        }
        input.value = '';
    }

    function viewImage(url) {
        Swal.fire({ imageUrl: url, imageAlt: 'รูปภาพประกอบ', showConfirmButton: false, showCloseButton: true, width: 'auto' });
    }

    async function deleteImage(imageId) {
        const result = await Swal.fire({
            title: 'ลบรูปภาพ?', text: 'ต้องการลบรูปภาพนี้หรือไม่?', icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#dc2626', cancelButtonColor: '#6b7280',
            confirmButtonText: 'ลบ', cancelButtonText: 'ยกเลิก'
        });
        if (result.isConfirmed) {
            try {
                const res = await fetchAPI(`/api/orders/${orderId}/images/`, {
                    method: 'DELETE', body: JSON.stringify({ image_id: imageId })
                });
                if (res.ok) Swal.fire('ลบแล้ว', 'ลบรูปภาพเรียบร้อย', 'success').then(() => location.reload());
            } catch (err) { console.error(err); }
        }
    }

    // Load images on page load
    document.addEventListener('DOMContentLoaded', loadImages);

    // Scroll to images section
    function scrollToImages() {
        document.getElementById('imageGallery').scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}
