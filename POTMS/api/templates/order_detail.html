{% extends "base.html" %}
{% block title %}รายละเอียดใบสั่งซื้อ{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold">รายละเอียดใบสั่งซื้อ</h1>
        <p class="text-sm text-base-content/50" id="orderBreadcrumb">—</p>
    </div>
    <button class="btn btn-ghost btn-sm" onclick="window.history.back()">← กลับ</button>
</div>

<!-- Order Info -->
<div class="card bg-base-200 border border-base-content/5 mb-6">
    <div class="card-body" id="orderInfo"></div>
</div>

<!-- Items -->
<div class="card bg-base-200 border border-base-content/5 mb-6">
    <div class="card-body">
        <h2 class="card-title text-lg mb-3">รายการวัสดุ</h2>
        <div class="overflow-x-auto">
            <table class="table table-zebra">
                <thead><tr><th>#</th><th>ชื่อวัสดุ</th><th>จำนวน</th><th>หน่วย</th><th>ราคาต่อหน่วย</th><th>รวม</th></tr></thead>
                <tbody id="itemsTable"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Partial Receives -->
<div class="card bg-base-200 border border-base-content/5 mb-6 hidden" id="receivesSection">
    <div class="card-body">
        <h2 class="card-title text-lg mb-3">ใบรับของ</h2>
        <div class="overflow-x-auto">
            <table class="table table-zebra">
                <thead><tr><th>เลขที่ใบรับ</th><th>วันที่รับ</th><th>สถานะ</th></tr></thead>
                <tbody id="receivesTable"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="flex gap-3" id="actions"></div>
{% endblock %}

{% block extra_js %}
<script>
    const orderId = new URLSearchParams(window.location.search).get('id');

    async function loadOrder() {
        const d = await apiFetch(`/api/orders/${orderId}/`);
        if (d.error) { showToast(d.error, 'error'); return; }

        document.getElementById('orderBreadcrumb').textContent = d.order_no;
        document.getElementById('orderInfo').innerHTML = `
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div><div class="text-xs opacity-50">เลขที่</div><div class="font-semibold">${d.order_no}</div></div>
                <div><div class="text-xs opacity-50">โครงการ</div><div>${d.project_name}</div></div>
                <div><div class="text-xs opacity-50">ผู้ขอซื้อ</div><div>${d.requester.full_name}</div></div>
                <div><div class="text-xs opacity-50">จำนวนเงิน</div><div class="font-semibold text-primary">฿${parseFloat(d.total_amount).toLocaleString()}</div></div>
                <div><div class="text-xs opacity-50">สถานะ</div><div>${getStatusBadge(d.status)}</div></div>
                <div><div class="text-xs opacity-50">วันที่สร้าง</div><div>${new Date(d.created_at).toLocaleDateString('th-TH')}</div></div>
            </div>
            ${d.reason ? `<div class="mt-4"><div class="text-xs opacity-50">เหตุผล</div><div class="mt-1">${d.reason}</div></div>` : ''}
        `;

        document.getElementById('itemsTable').innerHTML = d.items.map((item, i) => `
            <tr><td>${i+1}</td><td>${item.material_name}</td><td>${item.quantity}</td><td>${item.unit}</td><td>฿${parseFloat(item.unit_price).toLocaleString()}</td><td class="font-medium">฿${parseFloat(item.total_price).toLocaleString()}</td></tr>
        `).join('');

        if (d.partial_receives && d.partial_receives.length > 0) {
            document.getElementById('receivesSection').classList.remove('hidden');
            document.getElementById('receivesTable').innerHTML = d.partial_receives.map(r => `
                <tr><td>${r.receipt_no || '—'}</td><td>${new Date(r.received_date).toLocaleDateString('th-TH')}</td><td>${getStatusBadge(r.status)}</td></tr>
            `).join('');
        }

        const actions = document.getElementById('actions');
        if (['Draft','Rejected'].includes(d.status)) {
            actions.innerHTML += `<a href="/orders/edit/?id=${orderId}" class="btn btn-primary gap-2"><span class="material-icons-outlined text-base">edit</span>แก้ไข</a>`;
            actions.innerHTML += `<button class="btn btn-success gap-2" onclick="submitOrder()"><span class="material-icons-outlined text-base">send</span>ส่งใบสั่งซื้อ (ตรวจงบ)</button>`;
        }
        if (d.status === 'Reserved') {
            actions.innerHTML += `<button class="btn btn-primary gap-2" onclick="exportOrder()"><span class="material-icons-outlined text-base">upload_file</span>Export & ส่งรออนุมัติ</button>`;
        }
        if (d.status === 'Pending_Approval') {
            actions.innerHTML += `<button class="btn btn-success gap-2" onclick="recordApproval('approve')"><span class="material-icons-outlined text-base">check_circle</span>บันทึกอนุมัติ</button>`;
            actions.innerHTML += `<button class="btn btn-error gap-2" onclick="recordApproval('reject')"><span class="material-icons-outlined text-base">cancel</span>ส่งกลับแก้ไข</button>`;
        }
    }

    async function submitOrder() {
        const res = await apiFetch(`/api/orders/${orderId}/submit/`, { method: 'POST' });
        if (res.error) { showToast(res.error, 'error'); return; }
        showToast(res.message); location.reload();
    }

    async function exportOrder() {
        const res = await apiFetch(`/api/orders/${orderId}/export/`, { method: 'POST' });
        if (res.error) { showToast(res.error, 'error'); return; }
        showToast(res.message); location.reload();
    }

    async function recordApproval(action) {
        if (!confirm(action === 'approve' ? 'ยืนยันอนุมัติ?' : 'ส่งกลับแก้ไข?')) return;
        const res = await apiFetch(`/api/orders/${orderId}/approve/`, {
            method: 'POST', body: JSON.stringify({ action })
        });
        if (res.error) { showToast(res.error, 'error'); return; }
        showToast(res.message); location.reload();
    }

    loadOrder();
</script>
{% endblock %}
