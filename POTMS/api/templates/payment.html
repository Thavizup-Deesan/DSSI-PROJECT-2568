{% extends "base.html" %}
{% block title %}เบิกจ่ายเงิน{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold">ตั้งเบิกจ่ายเงิน</h1>
        <p class="text-sm text-base-content/50">เบิกจ่ายตามใบรับของ (ใบเสร็จ) ที่ตรวจรับผ่านแล้ว</p>
    </div>
</div>

<!-- Create Payment -->
<div class="card bg-base-200 border border-base-content/5 mb-6">
    <div class="card-body">
        <h2 class="card-title text-lg mb-3">ตั้งเบิกจ่าย</h2>
        <div class="flex gap-3 flex-wrap items-end">
            <div class="form-control flex-1 min-w-[300px]">
                <label class="label"><span class="label-text">เลือกใบรับของ (ตรวจรับผ่านแล้ว)</span></label>
                <select class="select select-bordered w-full" id="paymentReceiveSelect" onchange="onReceiveSelectChange()"><option value="">เลือกใบรับของ...</option></select>
            </div>
            <div class="form-control w-48">
                <label class="label"><span class="label-text">จำนวนเงินที่เบิก (บาท)</span></label>
                <input type="number" class="input input-bordered w-full" id="paymentAmount" step="0.01" placeholder="0.00">
            </div>
            <button class="btn btn-primary" onclick="createPayment()">ตั้งเบิกจ่าย</button>
        </div>
    </div>
</div>

<!-- Payment History -->
<div class="card bg-base-200 border border-base-content/5">
    <div class="card-body">
        <h2 class="card-title text-lg mb-3">ประวัติการเบิกจ่าย</h2>
        <div class="overflow-x-auto">
            <table class="table table-zebra">
                <thead><tr><th>ID</th><th>โครงการ</th><th>ใบสั่งซื้อ</th><th>ใบรับของ</th><th>จำนวนเงิน</th><th>วันที่เบิก</th><th>สถานะ</th><th>ดำเนินการ</th></tr></thead>
                <tbody id="paymentsTable"></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

    async function loadData() {
        const res = await apiFetch('/api/payments/');
        const payments = res.payments || [];
        const payableReceives = res.payable_receives || [];

        // Populate dropdown with payable receives
        const select = document.getElementById('paymentReceiveSelect');
        select.innerHTML = '<option value="" disabled selected>เลือกใบรับของ...</option>';

        payableReceives.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.receive_id;
            opt.textContent = `${r.receipt_no || 'PR-' + r.receive_id} — ${r.order_no} / ${r.project_name} (฿${parseFloat(r.value).toLocaleString()})`;
            opt.setAttribute('data-amount', r.value);
            select.appendChild(opt);
        });

        if (payableReceives.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'ไม่มีใบรับของที่รอเบิกจ่าย';
            opt.disabled = true;
            select.appendChild(opt);
        }

        // Populate payment history table
        const table = document.getElementById('paymentsTable');
        table.innerHTML = '';
        payments.forEach(p => {
            table.innerHTML += `
                <tr>
                    <td>${p.payment_id}</td>
                    <td>${p.project_name}</td>
                    <td>${p.order_no}</td>
                    <td>${p.receive_no || '—'}</td>
                    <td>฿${parseFloat(p.amount_paid).toLocaleString()}</td>
                    <td>${new Date(p.payment_date).toLocaleDateString('th-TH')}</td>
                    <td>${getStatusBadge(p.status)}</td>
                    <td>
                        ${p.status === 'Processing' ? 
                            `<button class="btn btn-ghost btn-xs text-primary" onclick="confirmPayment(${p.payment_id})">Confirm</button>` : 
                            '—'
                        }
                    </td>
                </tr>
            `;
        });
    }

    function onReceiveSelectChange() {
        const select = document.getElementById('paymentReceiveSelect');
        const option = select.options[select.selectedIndex];
        const amount = option ? option.getAttribute('data-amount') : '0';
        document.getElementById('paymentAmount').value = amount || '0';
    }

    async function createPayment() {
        const receiveId = document.getElementById('paymentReceiveSelect').value;
        const amount = document.getElementById('paymentAmount').value;

        if (!receiveId) { showToast('กรุณาเลือกใบรับของ', 'error'); return; }
        if (!amount || parseFloat(amount) <= 0) { showToast('กรุณาระบุจำนวนเงิน', 'error'); return; }

        if (!confirm(`ยืนยันการตั้งเบิกจ่ายยอด ${parseFloat(amount).toLocaleString()} บาท?`)) return;
        
        const res = await apiFetch('/api/payments/', {
            method: 'POST',
            body: JSON.stringify({ 
                receive_id: receiveId,
                amount_paid: amount
            })
        });
        if (res.error) { showToast(res.error, 'error'); return; }
        showToast(res.message); 
        
        // Reset Inputs
        document.getElementById('paymentReceiveSelect').value = "";
        document.getElementById('paymentAmount').value = "";
        
        await loadData();
    }
    
    async function confirmPayment(paymentId) {
        if (!confirm('ยืนยันว่าได้ทำการเบิกจ่ายเงินเรียบร้อยแล้ว?')) return;
        const res = await apiFetch(`/api/payments/${paymentId}/confirm/`, {
            method: 'POST'
        });
        if (res.error) { showToast(res.error, 'error'); return; }
        showToast(res.message);
        loadData();
    }

    // Initial load
    loadData();
</script>
{% endblock %}
