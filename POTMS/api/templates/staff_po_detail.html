<!DOCTYPE html>
<html lang="th">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ - POTMS</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap"
                rel="stylesheet">
        <style>
                body {
                        font-family: 'Prompt', sans-serif;
                }
        </style>
</head>

<body class="bg-gray-50 min-h-screen">

        <!-- Header -->
        <header class="bg-gradient-to-r from-cyan-600 to-teal-500 text-white py-3 sm:py-4 shadow-lg">
                <div
                        class="max-w-7xl mx-auto px-4 sm:px-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0">
                        <div class="flex items-center gap-2 sm:gap-3">
                                <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h1 class="text-base sm:text-xl font-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (PO)</h1>
                        </div>
                        <div class="flex items-center gap-3 text-sm">
                                <span id="staffName" class="hidden sm:inline">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: Staff</span>
                                <button onclick="logout()" class="hover:underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                        </div>
                </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-5xl mx-auto px-4 sm:px-6 py-4 sm:py-8">

                <!-- Back Link & Title -->
                <div class="mb-4 sm:mb-6">
                        <a href="/api/staff/po-management/"
                                class="text-cyan-600 hover:underline flex items-center gap-2 mb-2 text-sm">
                                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                                <span> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (PO)</span>
                        </a>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span id="orderNo"
                                        class="text-cyan-600">-</span></h2>
                        <p class="text-xs sm:text-sm text-gray-600 mt-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</p>
                </div>

                <!-- Order Info Card -->
                <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-100 mb-6">
                        <div class="flex flex-wrap justify-between items-start gap-4 mb-4">
                                <div>
                                        <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                                                <span class="text-cyan-500">üìã</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                                        </h3>
                                </div>
                                <span id="orderStatus" class="px-4 py-1.5 rounded-full text-sm font-semibold">-</span>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                        <p class="text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                                        <p id="orderTitle" class="font-medium text-gray-800">-</p>
                                </div>
                                <div>
                                        <p class="text-gray-500">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</p>
                                        <p id="vendorName" class="font-medium text-gray-800">-</p>
                                </div>
                                <div>
                                        <p class="text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
                                        <p id="orderDate" class="font-medium text-gray-800">-</p>
                                </div>
                                <div>
                                        <p class="text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
                                        <p id="requiredDate" class="font-medium text-gray-800">-</p>
                                </div>
                        </div>
                </div>

                <!-- Project & Requester Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Project Info -->
                        <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-100">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                        <span class="text-cyan-500"></span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                                </h3>
                                <div class="space-y-3 text-sm">
                                        <div>
                                                <p class="text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</p>
                                                <p id="projectName" class="font-medium text-gray-800">-</p>
                                        </div>
                                        <div class="p-3 bg-cyan-50 rounded-lg">
                                                <p class="text-gray-600 text-xs">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                                                <p class="text-lg font-bold text-cyan-600">‡∏ø <span
                                                                id="budgetRemaining">0</span></p>
                                        </div>
                                </div>
                        </div>

                        <!-- Requester Info -->
                        <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-100">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                        <span class="text-cyan-500"></span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á
                                </h3>
                                <div class="space-y-3 text-sm">
                                        <div>
                                                <p class="text-gray-500">‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
                                                <p id="requesterName" class="font-medium text-gray-800">-</p>
                                        </div>
                                        <div>
                                                <p class="text-gray-500">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</p>
                                                <p id="requesterDept" class="font-medium text-gray-800">-</p>
                                        </div>
                                </div>
                        </div>
                </div>

                <!-- Items Table -->
                <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-100 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <span class="text-cyan-500"></span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        </h3>
                        <div class="overflow-x-auto">
                                <table class="min-w-full">
                                        <thead>
                                                <tr class="border-b border-gray-200 bg-gray-50">
                                                        <th
                                                                class="px-4 py-3 text-left text-sm font-semibold text-gray-600">
                                                                #</th>
                                                        <th
                                                                class="px-4 py-3 text-left text-sm font-semibold text-gray-600">
                                                                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                                        <th
                                                                class="px-4 py-3 text-center text-sm font-semibold text-gray-600">
                                                                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                                        <th
                                                                class="px-4 py-3 text-center text-sm font-semibold text-gray-600">
                                                                ‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                                        <th
                                                                class="px-4 py-3 text-right text-sm font-semibold text-gray-600">
                                                                ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                                        <th
                                                                class="px-4 py-3 text-right text-sm font-semibold text-gray-600">
                                                                ‡∏£‡∏ß‡∏°</th>
                                                </tr>
                                        </thead>
                                        <tbody id="itemsTable">
                                                <!-- Items will be populated here -->
                                        </tbody>
                                        <tfoot>
                                                <tr class="border-t-2 border-gray-300 bg-gray-50">
                                                        <td colspan="5"
                                                                class="px-4 py-3 text-right font-semibold text-gray-700">
                                                                ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                                                        <td id="totalPrice"
                                                                class="px-4 py-3 text-right font-bold text-lg text-cyan-600">
                                                                ‡∏ø 0</td>
                                                </tr>
                                        </tfoot>
                                </table>
                        </div>
                </div>

                <!-- Description & Notes -->
                <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-100 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <span class="text-cyan-500"></span> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                        </h3>
                        <div class="text-sm text-gray-700" id="orderDesc">-</div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3">
                        <button onclick="printOrder()"
                                class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition flex items-center gap-2">
                                ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                        </button>
                        <a href="/api/staff/po-management/"
                                class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition">
                                ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PO
                        </a>
                </div>

        </main>

        <script>
                // Get order_id from Django template
                const orderId = '{{ order_id }}';
                let orderData = null;
                let projectData = null;
                let currentUser = null;

                // Initialize
                document.addEventListener('DOMContentLoaded', function () {
                        checkAuth();
                        loadOrderDetails();
                });

                // Check authentication
                function checkAuth() {
                        const user = JSON.parse(localStorage.getItem('user') || 'null');
                        if (!user || (user.role || '').toLowerCase() !== 'staff') {
                                Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ', 'error')
                                        .then(() => window.location.href = '/api/login-page/');
                                return;
                        }
                        currentUser = user;
                        document.getElementById('staffName').textContent = `‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ${user.username}`;
                }

                // Load order details
                async function loadOrderDetails() {
                        try {
                                // 1. Load order data
                                const orderRes = await fetch(`/api/orders/${orderId}/`);
                                if (!orderRes.ok) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
                                orderData = await orderRes.json();

                                // 2. Load project data
                                if (orderData.project_id) {
                                        const projectRes = await fetch(`/api/projects/${orderData.project_id}/`);
                                        if (projectRes.ok) {
                                                projectData = await projectRes.json();
                                        }
                                }

                                // 3. Load requester data
                                let requesterData = null;
                                if (orderData.requester_id) {
                                        const userRes = await fetch(`/api/users/${orderData.requester_id}/`);
                                        if (userRes.ok) {
                                                requesterData = await userRes.json();
                                        }
                                }

                                // 4. Render data
                                renderOrderDetails(orderData, projectData, requesterData);

                        } catch (error) {
                                console.error('Error:', error);
                                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
                        }
                }

                // Render order details
                function renderOrderDetails(order, project, requester) {
                        // Order info
                        document.getElementById('orderNo').textContent = order.order_no || order.id;
                        document.getElementById('orderTitle').textContent = order.title || order.order_no || '-';
                        document.getElementById('orderDesc').textContent = order.description || '-';
                        document.getElementById('vendorName').textContent = order.vendor_name || '-';

                        // Date formatting
                        const createdAt = order.created_at ? new Date(order.created_at._seconds * 1000 || order.created_at) : null;
                        document.getElementById('orderDate').textContent = createdAt ? createdAt.toLocaleDateString('th-TH') : '-';

                        const requiredDate = order.required_date ? new Date(order.required_date._seconds * 1000 || order.required_date) : null;
                        document.getElementById('requiredDate').textContent = requiredDate ? requiredDate.toLocaleDateString('th-TH') : '-';

                        // Status
                        const statusEl = document.getElementById('orderStatus');
                        const statusMap = {
                                'Draft': { text: '‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á', class: 'bg-gray-100 text-gray-700' },
                                'Pending': { text: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', class: 'bg-yellow-100 text-yellow-700' },
                                'WaitingBossApproval': { text: '‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', class: 'bg-purple-100 text-purple-700' },
                                'Approved': { text: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', class: 'bg-green-100 text-green-700' },
                                'Rejected': { text: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', class: 'bg-red-100 text-red-700' },
                                'CorrectionNeeded': { text: '‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', class: 'bg-orange-100 text-orange-700' },
                                'SentToProcurement': { text: '‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡πâ‡∏ß', class: 'bg-indigo-100 text-indigo-700' },
                                'ReceivedFromProcurement': { text: '‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡πâ‡∏ß', class: 'bg-teal-100 text-teal-700' },
                                'WaitingInspection': { text: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö', class: 'bg-cyan-100 text-cyan-700' },
                                'Closed': { text: '‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß', class: 'bg-gray-200 text-gray-500' }
                        };
                        const statusInfo = statusMap[order.status] || { text: order.status, class: 'bg-gray-100 text-gray-700' };
                        statusEl.textContent = statusInfo.text;
                        statusEl.className = `px-4 py-1.5 rounded-full text-sm font-semibold ${statusInfo.class}`;

                        // Requester info
                        if (requester) {
                                document.getElementById('requesterName').textContent = requester.username || '-';
                                document.getElementById('requesterDept').textContent = requester.department || '-';
                        }

                        // Project info
                        if (project) {
                                document.getElementById('projectName').textContent = project.project_name || '-';

                                const budgetTotal = parseFloat(project.budget_total || 0);
                                const budgetReserved = parseFloat(project.budget_reserved || 0);
                                const budgetSpent = parseFloat(project.budget_spent || 0);
                                const budgetRemaining = budgetTotal - budgetReserved - budgetSpent;

                                document.getElementById('budgetRemaining').textContent = budgetRemaining.toLocaleString();
                        }

                        // Items table
                        const items = order.items || [];
                        const tbody = document.getElementById('itemsTable');
                        tbody.innerHTML = '';

                        let total = 0;
                        items.forEach((item, index) => {
                                const qty = parseFloat(item.quantity || item.quantity_requested || 0);
                                const price = parseFloat(item.estimated_unit_price || item.unit_price || 0);
                                const subtotal = qty * price;
                                total += subtotal;

                                const row = document.createElement('tr');
                                row.className = 'border-b border-gray-100 hover:bg-gray-50';
                                row.innerHTML = `
                                        <td class="px-4 py-3 text-sm text-gray-600">${index + 1}</td>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-800">${item.item_name || item.name || '-'}</td>
                                        <td class="px-4 py-3 text-sm text-center text-gray-600">${qty}</td>
                                        <td class="px-4 py-3 text-sm text-center text-gray-600">${item.unit || '-'}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">‡∏ø ${price.toLocaleString()}</td>
                                        <td class="px-4 py-3 text-sm text-right font-medium text-gray-800">‡∏ø ${subtotal.toLocaleString()}</td>
                                `;
                                tbody.appendChild(row);
                        });

                        document.getElementById('totalPrice').textContent = `‡∏ø ${total.toLocaleString()}`;
                }

                // Print order
                function printOrder() {
                        window.open(`/api/orders/${orderId}/print/`, '_blank');
                }

                // Logout
                function logout() {
                        localStorage.removeItem('user');
                        window.location.href = '/api/login-page/';
                }
        </script>

</body>

</html>