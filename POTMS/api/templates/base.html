<!DOCTYPE html>
<html lang="th" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}POTMS{% endblock %}</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <!-- Tailwind CSS + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { thai: ['Noto Sans Thai', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-base-300 min-h-screen font-thai">
    <div class="drawer lg:drawer-open">
        <input id="sidebar-toggle" type="checkbox" class="drawer-toggle" />

        <!-- Main Content -->
        <div class="drawer-content">
            <!-- Mobile Navbar -->
            <div class="navbar bg-base-200 lg:hidden border-b border-base-content/10">
                <label for="sidebar-toggle" class="btn btn-ghost btn-square">
                    <span class="material-icons-outlined">menu</span>
                </label>
                <span class="text-lg font-bold ml-2">POTMS</span>
            </div>

            <main class="p-4 md:p-8">
                {% block content %}{% endblock %}
            </main>
        </div>

        <!-- Sidebar -->
        <div class="drawer-side z-50">
            <label for="sidebar-toggle" aria-label="close sidebar" class="drawer-overlay"></label>
            <aside class="bg-base-200 w-64 min-h-screen flex flex-col border-r border-base-content/10">
                <!-- Logo -->
                <div class="p-5 border-b border-base-content/10">
                    <h2 class="text-xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">POTMS</h2>
                    <div class="badge badge-primary badge-outline badge-sm mt-2" id="userRoleBadge">—</div>
                </div>

                <!-- Navigation -->
                <div class="flex-1 overflow-y-auto p-3" id="sidebarNav"></div>

                <!-- User Footer -->
                <div class="p-3 border-t border-base-content/10">
                    <div class="flex items-center gap-3 px-3 py-2">
                        <div class="avatar placeholder">
                            <div class="bg-primary text-primary-content rounded-full w-9">
                                <span class="text-sm" id="userAvatar">?</span>
                            </div>
                        </div>
                        <div class="min-w-0">
                            <div class="text-sm font-medium truncate" id="userName">—</div>
                            <div class="text-xs opacity-50 truncate" id="userEmail">—</div>
                        </div>
                    </div>
                    <button class="btn btn-outline btn-error btn-sm w-full mt-2 gap-2" onclick="logout()">
                        <span class="material-icons-outlined text-base">logout</span>
                        ออกจากระบบ
                    </button>
                </div>
            </aside>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast toast-top toast-end z-[9999] hidden">
        <div class="alert" id="toastAlert">
            <span id="toastMsg"></span>
        </div>
    </div>

    <script>
        function getCookie(name) {
            const v = `; ${document.cookie}`;
            const parts = v.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }

        async function apiFetch(url, options = {}) {
            const defaults = {
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                cache: 'no-store', // Prevent browser caching of API responses
            };
            const res = await fetch(url, { ...defaults, ...options });
            return res.json();
        }

        function showToast(message, type = 'success') {
            const el = document.getElementById('toast');
            const alert = document.getElementById('toastAlert');
            document.getElementById('toastMsg').textContent = message;
            alert.className = `alert ${type === 'error' ? 'alert-error' : 'alert-success'}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3500);
        }

        function getStatusBadge(status) {
            const map = {
                'Draft': 'badge-ghost', 'Active': 'badge-success', 'Reserved': 'badge-warning',
                'Pending_Approval': 'badge-warning', 'Approved': 'badge-info',
                'Completed': 'badge-secondary', 'Rejected': 'badge-error',
                'Closed': 'badge-ghost', 'Processing': 'badge-warning',
                'Paid': 'badge-success', 'Pending_Inspection': 'badge-warning',
                'Partially_Paid': 'badge-warning',
                'Inspected': 'badge-info', 'Pass': 'badge-success', 'Reject': 'badge-error',
                'Officer': 'badge-primary', 'Requester': 'badge-info', 'Inspector': 'badge-accent',
                'Revising': 'badge-warning', 'Cancelled': 'badge-error',
                'User': 'badge-info', 'Head': 'badge-secondary',
            };
            return `<span class="badge ${map[status] || 'badge-ghost'} badge-sm">${status.replace(/_/g, ' ')}</span>`;
        }

        async function logout() {
            await apiFetch('/api/auth/logout/', { method: 'POST' });
            window.location.href = '/login/';
        }

        async function loadUserInfo() {
            const data = await apiFetch('/api/auth/me/');
            if (data.error) { window.location.href = '/login/'; return null; }

            document.getElementById('userName').textContent = data.full_name;
            document.getElementById('userEmail').textContent = data.email;
            const roleBadge = document.getElementById('userRoleBadge');
            const roles = [];
            if (data.is_admin) roles.push('Admin');
            if (data.is_officer) roles.push('Officer');
            if (data.is_head) roles.push('Head');
            
            // Check implicit role from API if flags are all false
            if (roles.length === 0 && data.role === 'Inspector') {
                roles.push('Inspector');
            }
            
            roleBadge.textContent = roles.length ? roles.join(', ') : 'Requester';
            document.getElementById('userAvatar').textContent = (data.full_name || '?')[0].toUpperCase();

            const nav = document.getElementById('sidebarNav');
            const current = window.location.pathname;
            const link = (href, icon, label) =>
                `<a href="${href}" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-colors ${current === href ? 'bg-primary/15 text-primary font-medium' : 'text-base-content/70 hover:bg-base-content/5 hover:text-base-content'}">
                    <span class="material-icons-outlined text-xl">${icon}</span>${label}
                </a>`;
            const section = (title, items) =>
                `<div class="mb-4"><div class="px-3 mb-1 text-[11px] font-semibold uppercase tracking-wider opacity-40">${title}</div>${items}</div>`;

            let navHtml = '';

            if (data.is_admin) {
                navHtml += section('ผู้ดูแลระบบ', link('/officer/admins/', 'admin_panel_settings', 'จัดการ Admin'));
            } else if (data.is_officer) {
                navHtml +=
                    section('ภาพรวม', link('/officer/dashboard/', 'dashboard', 'Dashboard')) +
                    section('จัดการโครงการ',
                        link('/projects/', 'folder', 'โครงการ') +
                        link('/officer/users/', 'group', 'จัดการผู้ใช้')) +
                    section('ใบสั่งซื้อ',
                        link('/officer/orders/', 'receipt_long', 'ใบสั่งซื้อทั้งหมด') +
                        link('/partial-receives/', 'inventory_2', 'ใบรับของ') +
                        link('/inspections/', 'fact_check', 'ตรวจรับ')) +
                    section('การเงิน', link('/payments/', 'payments', 'เบิกจ่าย'));
            } else if (data.role === 'Inspector') {
                navHtml +=
                    section('ภาพรวม', link('/inspections/', 'dashboard', 'Dashboard (ตรวจรับ)')) +
                    section('การทำงาน',
                        link('/inspections/', 'fact_check', 'ตรวจรับสินค้า'));
            } else {
                navHtml +=
                    section('ภาพรวม', link('/user/dashboard/', 'dashboard', 'Dashboard')) +
                    section('ใบสั่งซื้อ',
                        link('/orders/my/', 'receipt_long', 'ใบสั่งซื้อของฉัน') +
                        link('/orders/create/', 'add_circle', 'สร้างใบสั่งซื้อ'));
            }

            nav.innerHTML = navHtml;
            return data;
        }

        if (window.location.pathname !== '/login/') loadUserInfo();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
