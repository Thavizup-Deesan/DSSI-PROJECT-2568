{% extends "base.html" %}
{% block title %}จัดการโครงการ{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold">จัดการโครงการ</h1>
        <p class="text-sm text-base-content/50">UC-01: นำเข้าและตั้งค่าโครงการ</p>
    </div>
    <button class="btn btn-primary btn-sm gap-2" onclick="showCreateModal()">
        <span class="material-icons-outlined text-base">add</span> สร้างโครงการ
    </button>
</div>

<div class="card bg-base-200 border border-base-content/5">
    <div class="card-body">
        <div class="overflow-x-auto">
            <table class="table table-zebra">
                <thead><tr><th>ชื่อโครงการ</th><th>งบประมาณ</th><th>งบคงเหลือ</th><th>สถานะ</th><th>การดำเนินการ</th></tr></thead>
                <tbody id="projectsTable"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<dialog class="modal" id="projectModal">
    <div class="modal-box w-11/12 max-w-4xl">
        <h3 class="font-bold text-lg" id="modalTitle">สร้างโครงการใหม่</h3>
        <input type="hidden" id="editProjectId">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div class="form-control">
                <label class="label"><span class="label-text">รหัส UBUFMIS</span></label>
                <input type="text" class="input input-bordered" id="ubufmisCode" placeholder="ระบุรหัส UBUFMIS">
            </div>
            <div class="form-control">
                <label class="label"><span class="label-text">ชื่อโครงการ</span></label>
                <input type="text" class="input input-bordered" id="projectName" placeholder="ระบุชื่อโครงการ">
            </div>
            <div class="form-control">
                <label class="label"><span class="label-text">งบประมาณทั้งหมด</span></label>
                <input type="number" class="input input-bordered" id="totalBudget" step="0.01" value="0">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-4">
            <div class="form-control">
                <label class="label"><span class="label-text">วันเริ่มต้น</span></label>
                <input type="date" class="input input-bordered w-full" id="startDate">
            </div>
            <div class="form-control">
                <label class="label"><span class="label-text">วันสิ้นสุด</span></label>
                <input type="date" class="input input-bordered w-full" id="endDate">
            </div>
        </div>
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="closeModal()">ยกเลิก</button>
            <button class="btn btn-primary" onclick="saveProject()">บันทึก</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>
{% endblock %}

{% block extra_js %}
<script>
    async function loadProjects() {
        const projects = await apiFetch('/api/projects/');
        const tbody = document.getElementById('projectsTable');
        if (projects.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-base-content/40">ยังไม่มีโครงการ</td></tr>';
            return;
        }
        tbody.innerHTML = projects.map(p => `
            <tr class="hover">
                <td class="font-medium">${p.project_name}</td>
                <td>฿${parseFloat(p.total_budget).toLocaleString()}</td>
                <td>฿${parseFloat(p.remaining_budget).toLocaleString()}</td>
                <td>${getStatusBadge(p.status)}</td>
                <td class="flex gap-1 flex-wrap">
                    ${p.status === 'Draft' ? `
                        <button class="btn btn-outline btn-xs" onclick="editProject(${p.project_id})">แก้ไข</button>
                        <a href="/projects/participants/?project_id=${p.project_id}" class="btn btn-outline btn-xs">ผู้เข้าร่วม</a>
                        <button class="btn btn-success btn-xs" onclick="startProject(${p.project_id})">เริ่มโครงการ</button>
                    ` : ''}
                    ${p.status === 'Active' ? `
                        <a href="/projects/participants/?project_id=${p.project_id}" class="btn btn-outline btn-xs">ผู้เข้าร่วม</a>
                        <button class="btn btn-error btn-xs" onclick="goToClosure(${p.project_id})">ปิดโครงการ</button>
                    ` : ''}
                </td>
            </tr>
        `).join('');
    }

    function showCreateModal() {
        document.getElementById('modalTitle').textContent = 'สร้างโครงการใหม่';
        document.getElementById('editProjectId').value = '';
        document.getElementById('projectName').value = '';
        document.getElementById('ubufmisCode').value = '';
        document.getElementById('totalBudget').value = '0';

        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('projectModal').showModal();
    }

    async function editProject(id) {
        const p = await apiFetch(`/api/projects/${id}/`);
        document.getElementById('modalTitle').textContent = 'แก้ไขโครงการ';
        document.getElementById('editProjectId').value = id;
        document.getElementById('projectName').value = p.project_name;
        document.getElementById('ubufmisCode').value = p.ubufmis_code || '';
        document.getElementById('totalBudget').value = p.total_budget || 0;

        document.getElementById('startDate').value = p.start_date || '';
        document.getElementById('endDate').value = p.end_date || '';
        document.getElementById('projectModal').showModal();
    }

    function closeModal() { document.getElementById('projectModal').close(); }

    async function saveProject() {
        const id = document.getElementById('editProjectId').value;
        const body = {
            project_name: document.getElementById('projectName').value,
            ubufmis_code: document.getElementById('ubufmisCode').value,
            total_budget: document.getElementById('totalBudget').value,

            start_date: document.getElementById('startDate').value || null,
            end_date: document.getElementById('endDate').value || null,
        };
        
        let res;
        if (id) {
            res = await apiFetch(`/api/projects/${id}/`, { method: 'PUT', body: JSON.stringify(body) });
        } else {
            res = await apiFetch('/api/projects/', { method: 'POST', body: JSON.stringify(body) });
        }
        
        if (res.error) { showToast(res.error, 'error'); return; }
        
        showToast(id ? 'แก้ไขโครงการสำเร็จ' : 'สร้างโครงการสำเร็จ');
        closeModal();
        loadProjects();
    }

    async function startProject(id) {
        if (!confirm('เริ่มโครงการนี้?')) return;
        const res = await apiFetch(`/api/projects/${id}/start/`, { method: 'POST' });
        if (res.error) { showToast(res.error, 'error'); return; }
        showToast(res.message); loadProjects();
    }

    function goToClosure(id) {
        window.location.href = `/projects/closure/?project_id=${id}`;
    }

    loadProjects();
</script>
{% endblock %}
