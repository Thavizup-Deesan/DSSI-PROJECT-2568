@startuml
title แผนภาพกิจกรรมระบบติดตามการสั่งซื้อ POTMS (Updated Flow)

' กำหนด Swimlanes
|ผู้ขอซื้อ (User)|
start
:เข้าสู่ระบบ (Login);

:เลือกประเภท (พัสดุ/ครุภัณฑ์);

:เลือกโครงการ (Select Project);
note right
  User เลือกโครงการที่มี
  งบประมาณเหลือเพียงพอ
end note

:สร้างใบขอซื้อ (Create Order);
:เพิ่มรายการสินค้า;
note right
  - ชื่อสินค้า
  - จำนวน, หน่วย
  - ราคาประมาณการ
end note

if (เลือกการทำงาน?) then (บันทึกร่าง)
    :กดบันทึก;
    #AliceBlue:สถานะ: Draft;
    detach
else (ส่งขออนุมัติ)
    :กดส่งขออนุมัติ;
    #LightYellow:สถานะ: รอ (รอหัวหน้าอนุมัติ);
endif

|หัวหน้าภาควิชา (Boss)|
note right
  **กระบวนการ Offline:**
  หัวหน้าตรวจสอบเอกสารและ
  ลงนามอนุมัติแบบ Offline
end note

if (หัวหน้าอนุมัติ?) then (อนุมัติ)
    |พัสดุ (Staff)|
    :อัปเดตสถานะในระบบ;
    #LightGreen:สถานะ: รอรับของ;
    
    :ดำเนินการจัดซื้อ;
    :รับของจากผู้ขาย;
    
    |ผู้ขอซื้อ (User)|
    :อัปโหลดรูปภาพประกอบ (เช่น ใบเสร็จ);
    note right
      User สามารถอัปโหลดรูปภาพ
      ประกอบใบขอซื้อได้
    
else (ไม่อนุมัติ)
    |พัสดุ (Staff)|
    :อัปเดตสถานะ: Rejected;
    #Pink:สถานะ: Rejected;
    
    |ผู้ขอซื้อ (User)|
    :ดูเหตุผลที่ไม่อนุมัติ;
    stop
endif

|คณะกรรมการตรวจรับ|
note right
  **กระบวนการ Offline:**
  คณะกรรมการสแกน QR Code
  เพื่อดูรายการสินค้า
  และตรวจนับของจริง
end note

:สแกน QR Code ดูรายการ;
:ตรวจนับสินค้า (Offline);
:ลงนามรับรอง (Offline);

|ผู้ขอซื้อ (User)|
:บันทึกการรับของในระบบ;
note right
  User บันทึกจำนวนที่รับ
  ตามที่คณะกรรมการตรวจรับแล้ว
end note

if (รับครบทุกรายการ?) then (รับครบ)
    #LightGreen:สถานะ: รับครบ;
else (รับบางส่วน)
    #LightBlue:สถานะ: รับบางส่วน;
    
    fork
        :รอรับของเพิ่มเติม;
    fork again
        |ผู้ขอซื้อ (User)|
        :บันทึกการรับของรอบถัดไป;
    end fork
    
    if (รับครบแล้ว?) then (ใช่)
        #LightGreen:สถานะ: รับครบ;
    else (รอต่อ)
        #LightBlue:สถานะ: รับบางส่วน;
        detach
    endif
endif

|ผู้ขอซื้อ (User)|
:ดูประวัติใบขอซื้อ;
:ค้นหา/กรองรายการ;

stop
@enduml