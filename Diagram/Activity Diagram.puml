@startuml
title แผนภาพกิจกรรมระบบติดตามการสั่งซื้อ (Updated Flow)

' กำหนด Swimlanes
|Staff (เจ้าหน้าที่)|
start
:นำเข้าโครงการ (Import Excel/CSV);
note right
  **Phase 2 (Done):**
  Staff เตรียมข้อมูลโครงการ
  และตั้งงบประมาณ (Master Data)
end note

|User (ผู้สั่งซื้อ)|
:เลือกโครงการ (Select Project);
note right
  **Phase 3 (Start):**
  User เลือกโครงการที่มีอยู่
  เพื่อเริ่มขอซื้อ
end note

:สร้างรายการสินค้า (Order Item);
note right
  User สามารถ Import Excel (รายการสินค้า)
  หรือกรอกสดรายรายการ
end note

' ส่วนตัดสินใจ บันทึก vs สั่งซื้อ
if (เลือกการทำงาน) then (กดบันทึก Draft)
    :กดบันทึก;
    note right: ยังไม่ส่งข้อมูลเข้าระบบ
    #AliceBlue:สถานะ: Draft\n(บันทึกร่าง);
    detach
else (กดสั่งซื้อ)
    :กดสั่งซื้อ;
    
    |System (ระบบ)|
    note right
      ตรวจสอบงบคงเหลือ
      และตัดยอดสำรอง (Reserve)
    end note
    if (งบประมาณเพียงพอ?) then (ใช่)
        :ตัดงบสำรอง (Reserve Budget);
        #LightGreen:สถานะ: สั่งซื้อ (Ordered);
    else (ไม่)
        :แจ้งเตือนวงเงินไม่พอ;
        stop
    endif
endif

|Staff (เจ้าหน้าที่)|
:ดูรายการสั่งซื้อทั้งหมด;
:พิมพ์ใบสั่งซื้อ & เสนอหัวหน้าอนุมัติ;
note right
  ระบุกรรมการตรวจรับ,
  ผู้สั่งซื้อ
end note

' Loop การแก้ไข (Correction Loop)
while (ต้องการแก้ไข?) is (ใช่)
    :บันทึกสิ่งที่ต้องแก้ไข;
    :อัปเดตสถานะ;
    #Pink:สถานะ: ต้องแก้ไข (Correction Needed);
    
    |System (ระบบ)|
    :คืนยอดงบสำรอง (Release Budget); 
    note right: คืนงบชั่วคราวเพื่อให้แก้ไข

    |User (ผู้สั่งซื้อ)|
    :ดูรายละเอียด (View Details);
    :แก้ไขข้อมูล & ยืนยัน (อนุมัติแก้ไข);
    
    |System (ระบบ)|
    note right
      กันงบใหม่ตามยอดที่แก้ไข
    end note
    if (งบประมาณเพียงพอ?) then (ใช่)
        :ตัดงบสำรองใหม่ (Re-reserve);
        #LightGreen:สถานะ: แก้ไขเรียบร้อย (Correction Approved);
    else (ไม่)
        :แจ้งเตือนวงเงินไม่พอ;
        stop
    endif
    
    |Staff (เจ้าหน้าที่)|
    :ตรวจสอบการแก้ไข;
endwhile (ไม่)

' Process หลังอนุมัติผ่าน
:Export เป็นไฟล์ CSV;
:ส่งใบสั่งซื้อให้พัสดุ;
#LightYellow:สถานะ: ส่งรายการให้ พัสดุ;

:รับของจากพัสดุ;
:เลือกรายการเพื่อสร้าง Sub-order;
#LightBlue:สถานะ: รอตรวจรับ;

partition "กระบวนการตรวจรับ (Inspection)" {
    :เปิดใบสั่งซื้อ / นับของ;
    :ลงชื่อ & บันทึกเข้าระบบ;
    note right
      สร้าง QR และสแกน
      เพื่อตรวจเช็คของ
    end note
    
    |System (ระบบ)|
    note right
      บันทึกยอดจ่ายจริง (Actual Cost)
      และปรับปรุงยอดงบประมาณ
    end note
    :บันทึกยอดจ่ายจริง;
    
    |Staff (เจ้าหน้าที่)|
    #LightGreen:สถานะ: ตรวจรับ;
}

|User (ผู้สั่งซื้อ)|
:ดูรายการสั่งซื้อ & รายละเอียด;
:ไปรับของ (Receive Items);

|Staff (เจ้าหน้าที่)|
repeat
    :ตรวจสอบ & จ่ายของ;
repeat while (ครบทุกรายการ?) is (ไม่)
-> ใช่;

:กดรับของแล้วในระบบ;
#LightGreen:สถานะ: รับของแล้ว;

:ปิดการสั่งซื้อ;
#Gray:สถานะ: ปิดการสั่งซื้อ;

stop
@enduml