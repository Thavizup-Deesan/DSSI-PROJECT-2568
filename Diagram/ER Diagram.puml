@startuml
' ตั้งค่าการแสดงผล
skinparam linetype ortho
hide circle
skinparam packageStyle rectangle

' --- Master Data Entities ---

entity "User (ผู้ใช้งาน)" as User {
  *user_id : INT <<PK>>
  --
  username : VARCHAR
  role : ENUM (User, Staff, Admin)
  department : VARCHAR
}

entity "Project (โครงการ)" as Project {
  *project_id : INT <<PK>>
  --
  project_name : VARCHAR
  budget_total : DECIMAL(10,2) (งบทั้งหมด)
  budget_reserved : DECIMAL(10,2) (งบที่ถูกจอง)
  budget_spent : DECIMAL(10,2) (งบจ่ายจริง)
  status : ENUM (Active, Completed, Cancelled) << เพิ่ม: สถานะโครงการ >>
  created_at : DATETIME
}

' --- Project Assignment (กำหนดผู้รับผิดชอบโครงการ) ---

entity "ProjectAssignment (มอบหมายโครงการ)" as ProjectAssignment {
  *assignment_id : INT <<PK>>
  --
  *project_id : INT <<FK>> (โครงการ)
  *user_id : INT <<FK>> (User ที่รับผิดชอบ)
  --
  assigned_by : INT <<FK>> (Staff ที่กำหนด)
  assigned_at : DATETIME
  note : TEXT (หมายเหตุ)
}

' --- Transaction Entities ---

entity "MainOrder (ใบสั่งซื้อหลัก)" as MainOrder {
  *order_id : INT <<PK>>
  --
  *project_id : INT <<FK>>
  *requester_id : INT <<FK>> (User ผู้สั่ง)
  *approver_id : INT <<FK>> (Staff ผู้อนุมัติ)
  --
  order_no : VARCHAR (เลขที่เอกสาร)
  vendor_name : VARCHAR (ชื่อร้านค้า/บริษัท)
  status : ENUM (Draft, Ordered, CorrectionNeeded, SentToProcurement, Closed)
  total_estimated_price : DECIMAL (ราคารวมประมาณการ)
  inspection_committee : TEXT (รายชื่อกรรมการตรวจรับ)
  staff_note : TEXT (บันทึกสิ่งที่ต้องแก้ไขจาก Staff)
  created_at : DATETIME
  updated_at : DATETIME
}

entity "OrderItem (รายการสินค้า)" as OrderItem {
  *item_id : INT <<PK>>
  --
  *order_id : INT <<FK>>
  --
  item_name : VARCHAR
  quantity_requested : INT
  unit : VARCHAR
  estimated_unit_price : DECIMAL
  status : ENUM (Pending, Received, Cancelled)
}

entity "SubOrder (ใบตรวจรับ/รับของ)" as SubOrder {
  *sub_order_id : INT <<PK>>
  --
  *main_order_id : INT <<FK>>
  *receiver_id : INT <<FK>>
  --
  sub_order_no : VARCHAR
  received_date : DATETIME
  status : ENUM (WaitingInspection, Inspected, HandedOver)
  note : TEXT
}

entity "InspectionDetail (รายละเอียดการรับของ)" as InspectionDetail {
  *inspection_id : INT <<PK>>
  --
  *sub_order_id : INT <<FK>>
  *item_id : INT <<FK>>
  --
  qty_received : INT
  actual_unit_price : DECIMAL
  total_actual_price : DECIMAL
  qr_code : VARCHAR
  is_verified : BOOLEAN
}

' --- Relationships ---

' User & Project Assignment (Many-to-Many ผ่าน ProjectAssignment)
Project ||..o{ ProjectAssignment : "Has Assignees"
User ||..o{ ProjectAssignment : "Assigned By (Staff)"

' Orders
User ||..o{ MainOrder : "Creates (Requester)"
User ||..o{ SubOrder : "Receives Items (Staff)"
Project ||..o{ MainOrder : "Has"

MainOrder ||..|{ OrderItem : "Contains"
MainOrder ||..o{ SubOrder : "Splits into"

SubOrder ||..|{ InspectionDetail : "Includes"
OrderItem ||..o{ InspectionDetail : "Fulfilled by"

@enduml